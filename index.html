<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Mini App - Investment & Rewards</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0088cc, #006699);
    color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #005f99;
    padding: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  main {
    flex-grow: 1;
    max-width: 480px;
    margin: 1rem auto;
    background: rgba(0, 0, 0, 0.35);
    border-radius: 10px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.7);
  }
  h2 {
    margin-top: 0;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  button, input[type="submit"] {
    background: #00b8fa;
    border: none;
    border-radius: 6px;
    padding: 0.6rem 1.2rem;
    margin: 0.5rem 0;
    font-weight: 600;
    color: #00345c;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover, input[type="submit"]:hover {
    background: #0095cc;
    color: white;
  }
  input[type="text"], input[type="password"], input[type="number"] {
    width: 100%;
    padding: 0.5rem 0.75rem;
    margin: 0.4rem 0 1rem 0;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  section {
    margin-bottom: 2rem;
  }
  label {
    font-weight: 600;
  }
  .btn-secondary {
    background: #0070b8;
    color: #cce9fb;
  }
  .btn-danger {
    background: #cc3300;
    color: #fff;
  }
  .hidden {
    display: none !important;
  }
  .notification {
    background: #0070b8;
    margin: 0.75rem 0;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    box-shadow: 0 0 5px #0070b8af;
    text-align: center;
    font-weight: 600;
    letter-spacing: 0.03em;
  }
  nav {
    margin-bottom: 1rem;
    text-align: center;
  }
  nav button {
    margin: 0 6px;
  }
  .referral-link {
    word-break: break-word;
    background: #004466;
    padding: 0.8rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
  }
  .referral-link:hover {
    background: #003355;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }
  table th, table td {
    border: 1px solid #0095cc;
    padding: 0.4rem 0.8rem;
    text-align: center;
  }
  table th {
    background-color: #0077aa;
  }
  footer {
    text-align: center;
    padding: 1rem 0;
    font-size: 0.9rem;
    background: #003355;
    color: #aaccff;
  }
  /* Scroll area */
  #adminPanel .scrollable {
    max-height: 250px;
    overflow-y: auto;
    margin-top: 0.5rem;
    border-radius: 6px;
  }
  /* Video ad placeholder */
  #videoAd {
    background: #002633;
    border: 2px solid #0095cc;
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
    text-align: center;
  }
  #videoAd video {
    max-width: 100%;
    border-radius: 10px;
  }
</style>
</head>
<body>
<header>Telegram Mini App</header>
<main>
  <nav id="navBar" class="hidden">
    <button id="btnDashboard" class="btn-secondary">Dashboard</button>
    <button id="btnInvest" class="btn-secondary">Investment</button>
    <button id="btnRewards" class="btn-secondary">Rewards</button>
    <button id="btnDepositWithdraw" class="btn-secondary">Deposit/Withdraw</button>
    <button id="btnReferral" class="btn-secondary">Referral</button>
    <button id="btnAdmin" class="btn-danger">Admin Panel</button>
    <button id="btnLogout" class="btn-danger">Logout</button>
  </nav>

  <!-- Login Screen -->
  <section id="sectionLogin">
    <h2>Login with Telegram</h2>
    <div id="loginMsg" class="notification" style="background:#0095cc;">Please click the button below to login with your Telegram account.</div>
    <button id="loginTelegramBtn">Login with Telegram Account</button>
  </section>

  <!-- Dashboard -->
  <section id="sectionDashboard" class="hidden">
    <h2>Dashboard</h2>
    <p><strong>User:</strong> <span id="userNameDisplay"></span></p>
    <p><strong>Balance:</strong> <span id="userBalanceDisplay">0</span> tokens</p>
    <p><strong>Referral Bonus:</strong> <span id="userReferralBonusDisplay">0</span> tokens</p>
    <p><strong>Weekly Profit:</strong> <span id="userProfitDisplay">0</span> tokens</p>
    <p><strong>Investment Package:</strong> <span id="userInvestPackage">None</span></p>
  </section>

  <!-- Investment Section -->
  <section id="sectionInvest" class="hidden">
    <h2>Weekly Investment Packages</h2>
    <div>
      <p>Select a package to invest. Profits will be generated weekly (simulated).</p>
      <table>
        <thead>
          <tr><th>Package</th><th>Investment</th><th>Weekly Profit %</th><th>Action</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Basic</td>
            <td>100 tokens</td>
            <td>5%</td>
            <td><button class="buyInvestPackage" data-package="Basic" data-amount="100" data-profit="5">Invest</button></td>
          </tr>
          <tr>
            <td>Standard</td>
            <td>500 tokens</td>
            <td>7%</td>
            <td><button class="buyInvestPackage" data-package="Standard" data-amount="500" data-profit="7">Invest</button></td>
          </tr>
          <tr>
            <td>Premium</td>
            <td>1000 tokens</td>
            <td>10%</td>
            <td><button class="buyInvestPackage" data-package="Premium" data-amount="1000" data-profit="10">Invest</button></td>
          </tr>
        </tbody>
      </table>
      <div id="investMsg" class="notification hidden"></div>
      <button id="backToDashboardFromInvest" class="btn-secondary">Back to Dashboard</button>
    </div>
  </section>

  <!-- Rewards Section -->
  <section id="sectionRewards" class="hidden">
    <h2>Rewards System</h2>
    <p>Earn tokens by watching video ads or clicking rewarded ads.</p>

    <div id="videoAd">
      <video id="rewardVideo" width="320" height="180" controls preload="none" poster="https://i.imgur.com/YU8ldIU.jpg">
        <source src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm" type="video/webm"/>
        Your browser does not support the video tag.
      </video>
      <button id="btnWatchAd" class="btn-secondary">Watch Video Ad (+10 tokens)</button>
      <p id="videoRewardStatus" style="font-size:0.9rem;color:#a4d4ff;"></p>
    </div>

    <div style="margin-top: 1rem;">
      <button id="btnPayPerClick" class="btn-secondary">Click Here for PPC Reward (+5 tokens)</button>
      <p id="ppcRewardStatus" style="font-size:0.9rem;color:#a4d4ff;"></p>
    </div>

    <button id="backToDashboardFromRewards" class="btn-secondary">Back to Dashboard</button>
  </section>

  <!-- Deposit and Withdraw -->
  <section id="sectionDepositWithdraw" class="hidden">
    <h2>Offline Deposit and Withdrawal</h2>
    <p>Request deposit or withdrawal. Admin approval required.</p>
    <form id="depositWithdrawForm">
      <label for="operation">Operation:</label>
      <select id="operation" required>
        <option value="">Select operation</option>
        <option value="deposit">Deposit</option>
        <option value="withdraw">Withdraw</option>
      </select>
      <label for="amount">Amount (tokens):</label>
      <input type="number" id="amount" min="1" required />
      <input type="submit" value="Submit Request" />
    </form>
    <div id="depositWithdrawMsg" class="notification hidden"></div>
    <button id="backToDashboardFromDW" class="btn-secondary">Back to Dashboard</button>
  </section>

  <!-- Referral Section -->
  <section id="sectionReferral" class="hidden">
    <h2>Referral Program</h2>
    <p>Your referral link (click to copy):</p>
    <div id="referralLinkDisplay" class="referral-link" tabindex="0"></div>
    <p>Referrals joined: <span id="referralsCount">0</span></p>
    <p>Referral bonus earned: <span id="referralBonusEarned">0</span> tokens</p>
    <button id="backToDashboardFromReferral" class="btn-secondary">Back to Dashboard</button>
  </section>

  <!-- Admin Panel -->
  <section id="sectionAdmin" class="hidden">
    <h2>Admin Panel</h2>
    <div id="adminLoginSection">
      <label for="adminPassword">Enter Admin Password:</label>
      <input type="password" id="adminPassword" placeholder="Admin Password" />
      <button id="btnAdminLogin">Login to Admin Panel</button>
      <p id="adminLoginMsg" style="color:#fcc"></p>
    </div>
    <div id="adminPanel" class="hidden">
      <h3>Pending Deposit/Withdrawal Requests</h3>
      <div class="scrollable">
        <table id="requestsTable">
          <thead>
            <tr><th>User</th><th>Operation</th><th>Amount</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody>
            <!-- Requests inserted here dynamically -->
          </tbody>
        </table>
      </div>
      <button id="btnLogoutAdmin" class="btn-danger">Logout Admin Panel</button>
    </div>
  </section>
</main>
<footer>
  &copy; 2024 Telegram Mini App Demo
</footer>

<script>
  // Telegram Mini App Demo - Frontend Only Logic
  (() => {
    const telegramDomain = 'https://t.me/yourchannel'; // Placeholder for referral link base

    // Globals
    const appData = {
      users: {}, // key: telegram_id string, value: user object
      currentUserId: null,
      adminPassword: 'admin123', // hardcoded admin pwd for demo only
      requests: [], // deposit/withdrawal requests queued
    };

    // Util to generate random referral codes for users
    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i=0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Storage keys for local persistence
    const STORAGE_KEY = 'telegram_mini_app_data';

    // Save appData.users and requests to localStorage
    function saveData() {
      const toSave = {
        users: appData.users,
        requests: appData.requests
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    }

    // Load data from localStorage
    function loadData() {
      const json = localStorage.getItem(STORAGE_KEY);
      if (json) {
        try {
          const parsed = JSON.parse(json) || {};
          appData.users = parsed.users || {};
          appData.requests = parsed.requests || [];
        } catch (e) {
          // corrupt data reset
          appData.users = {};
          appData.requests = [];
          localStorage.removeItem(STORAGE_KEY);
        }
      }
    }

    // UI elements
    const sections = {
      login: document.getElementById('sectionLogin'),
      dashboard: document.getElementById('sectionDashboard'),
      invest: document.getElementById('sectionInvest'),
      rewards: document.getElementById('sectionRewards'),
      depositWithdraw: document.getElementById('sectionDepositWithdraw'),
      referral: document.getElementById('sectionReferral'),
      admin: document.getElementById('sectionAdmin'),
    };
    const navBar = document.getElementById('navBar');
    const btnDashboard = document.getElementById('btnDashboard');
    const btnInvest = document.getElementById('btnInvest');
    const btnRewards = document.getElementById('btnRewards');
    const btnDepositWithdraw = document.getElementById('btnDepositWithdraw');
    const btnReferral = document.getElementById('btnReferral');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnLogout = document.getElementById('btnLogout');

    // Dashboard Elements
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userBalanceDisplay = document.getElementById('userBalanceDisplay');
    const userReferralBonusDisplay = document.getElementById('userReferralBonusDisplay');
    const userProfitDisplay = document.getElementById('userProfitDisplay');
    const userInvestPackage = document.getElementById('userInvestPackage');

    // Investment
    const investMsg = document.getElementById('investMsg');
    const backToDashboardFromInvest = document.getElementById('backToDashboardFromInvest');

    // Rewards
    const btnWatchAd = document.getElementById('btnWatchAd');
    const rewardVideo = document.getElementById('rewardVideo');
    const videoRewardStatus = document.getElementById('videoRewardStatus');
    const btnPayPerClick = document.getElementById('btnPayPerClick');
    const ppcRewardStatus = document.getElementById('ppcRewardStatus');
    const backToDashboardFromRewards = document.getElementById('backToDashboardFromRewards');

    // Deposit Withdraw
    const depositWithdrawForm = document.getElementById('depositWithdrawForm');
    const depositWithdrawMsg = document.getElementById('depositWithdrawMsg');
    const backToDashboardFromDW = document.getElementById('backToDashboardFromDW');

    // Referral
    const referralLinkDisplay = document.getElementById('referralLinkDisplay');
    const referralsCount = document.getElementById('referralsCount');
    const referralBonusEarned = document.getElementById('referralBonusEarned');
    const backToDashboardFromReferral = document.getElementById('backToDashboardFromReferral');

    // Admin Panel
    const adminSection = sections.admin;
    const adminLoginSection = document.getElementById('adminLoginSection');
    const adminPanel = document.getElementById('adminPanel');
    const adminPasswordInput = document.getElementById('adminPassword');
    const btnAdminLogin = document.getElementById('btnAdminLogin');
    const adminLoginMsg = document.getElementById('adminLoginMsg');
    const requestsTableBody = document.querySelector('#requestsTable tbody');
    const btnLogoutAdmin = document.getElementById('btnLogoutAdmin');

    // Navigation helpers
    function showSection(name) {
      Object.values(sections).forEach(sec => sec.classList.add('hidden'));
      if(name) sections[name].classList.remove('hidden');
    }

    function showNavBar(show = true) {
      if (show) navBar.classList.remove('hidden');
      else navBar.classList.add('hidden');
    }

    // Simulate Telegram login (since real Telegram login requires backend validation)
    function telegramLogin() {
      // Prompt username & id for demo
      let username = prompt('Enter your Telegram username (without @):', 'user'+Math.floor(Math.random()*1000));
      if (!username) return alert('Telegram username is required to login.');
      let telegram_id = username.toLowerCase();

      // Check referral from URL params for referral bonus
      let urlParams = new URLSearchParams(window.location.search);
      let referralCode = urlParams.get('ref');
      // Use or create user
      if (!appData.users[telegram_id]) {
        // Create new user
        let newUser = {
          telegram_id,
          username,
          balance: 50, // welcome bonus
          referralCode: generateReferralCode(),
          referredBy: null,
          referralBonus: 0,
          referrals: [],
          profit: 0,
          investment: {
            package: null,
            amount: 0,
            profit_percent: 0,
            invest_date: 0,
            lastProfitClaim: 0
          }
        };
        // Handle referral bonus
        if (referralCode) {
          // Find referrer user by referralCode
          let referrer = Object.values(appData.users).find(u => u.referralCode === referralCode);
          if (referrer && referrer.telegram_id !== telegram_id) {
            newUser.referredBy = referrer.telegram_id;
            referrer.referrals.push(telegram_id);
            referrer.referralBonus += 20; // flat 20 token referral bonus
            referrer.balance += 20;
            alert(`You were referred by @${referrer.username}. They received 20 tokens bonus.`);
          }
        }
        appData.users[telegram_id] = newUser;
        saveData();
      }

      appData.currentUserId = telegram_id;
      initUserUI();
      showNavBar(true);
      showSection('dashboard');
    }

    // Initialize user UI dashboard data
    function initUserUI() {
      let user = appData.users[appData.currentUserId];
      if (!user) return;

      userNameDisplay.textContent = '@' + user.username;
      userBalanceDisplay.textContent = user.balance.toFixed(2);
      userReferralBonusDisplay.textContent = user.referralBonus.toFixed(2);
      userProfitDisplay.textContent = user.profit.toFixed(2);
      userInvestPackage.textContent = user.investment.package || 'None';

      // Referral Section
      referralLinkDisplay.textContent = window.location.origin + window.location.pathname + '?ref=' + user.referralCode;
      referralsCount.textContent = user.referrals.length.toString();
      referralBonusEarned.textContent = user.referralBonus.toFixed(2);
    }

    // Logout user
    function logoutUser() {
      appData.currentUserId = null;
      showNavBar(false);
      showSection('login');
    }

    // Buy investment package
    function buyInvestPackage(pkg, amount, profitPercent) {
      let user = appData.users[appData.currentUserId];
      if (!user) return alert('User not found');

      if (user.balance < amount) {
        investMsg.textContent = 'Insufficient balance to invest.';
        investMsg.classList.remove('hidden');
        return;
      }
      if(user.investment.package) {
        investMsg.textContent = `You already invested in ${user.investment.package}. Wait for profit or withdraw.`;
        investMsg.classList.remove('hidden');
        return;
      }

      user.balance -= amount;
      user.investment = {
        package: pkg,
        amount: amount,
        profit_percent: profitPercent,
        invest_date: Date.now(),
        lastProfitClaim: Date.now(),
      };
      investMsg.textContent = `Investment in ${pkg} package successful!`;
      investMsg.classList.remove('hidden');
      saveData();
      initUserUI();
    }

    // Calculate weekly profit if due (simulate)
    function calculateWeeklyProfit() {
      let user = appData.users[appData.currentUserId];
      if (!user || !user.investment.package) return;

      const now = Date.now();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      if (now - user.investment.lastProfitClaim >= oneWeek) {
        let weeks = Math.floor((now - user.investment.lastProfitClaim) / oneWeek);
        let weeklyProfitTokens = (user.investment.amount * (user.investment.profit_percent / 100)) * weeks;
        user.balance += weeklyProfitTokens;
        user.profit += weeklyProfitTokens;
        user.investment.lastProfitClaim += weeks * oneWeek;
        saveData();
        initUserUI();
        alert(`Weekly profit of ${weeklyProfitTokens.toFixed(2)} tokens credited for ${weeks} week(s).`);
      }
    }

    // Reward for watching ad
    function watchVideoAdReward() {
      let user = appData.users[appData.currentUserId];
      if (!user) return;

      // Basic validation: user must watch video till end
      if (rewardVideo.readyState < 3) {
        videoRewardStatus.textContent = 'Load the video first and watch till the end.';
        return;
      }
      if (rewardVideo.ended) {
        user.balance += 10;
        saveData();
        initUserUI();
        videoRewardStatus.textContent = 'You earned +10 tokens for watching video ad!';
      } else {
        videoRewardStatus.textContent = 'Please watch the full video to earn reward.';
      }
    }

    // Pay per click reward
    function payPerClickReward() {
      let user = appData.users[appData.currentUserId];
      if (!user) return;

      user.balance += 5;
      saveData();
      initUserUI();
      ppcRewardStatus.textContent = 'You earned +5 tokens for PPC!';
      // Clear message after 3s
      setTimeout(() => {
        ppcRewardStatus.textContent = '';
      }, 3000);
    }

    // Submit deposit or withdraw request
    function submitDepositWithdrawRequest(e) {
      e.preventDefault();
      let op = document.getElementById('operation').value;
      let amount = parseFloat(document.getElementById('amount').value);
      if (!op || isNaN(amount) || amount <= 0) {
        depositWithdrawMsg.textContent = 'Please fill out all fields correctly.';
        depositWithdrawMsg.classList.remove('hidden');
        return;
      }
      let user = appData.users[appData.currentUserId];
      if (!user) {
        depositWithdrawMsg.textContent = 'User not found.';
        depositWithdrawMsg.classList.remove('hidden');
        return;
      }
      if (op === 'withdraw' && amount > user.balance) {
        depositWithdrawMsg.textContent = 'Insufficient balance for withdrawal.';
        depositWithdrawMsg.classList.remove('hidden');
        return;
      }
      // Create request object
      const req = {
        id: 'REQ-' + Date.now() + '-' + Math.floor(Math.random()*999),
        telegram_id: user.telegram_id,
        username: user.username,
        operation: op,
        amount,
        status: 'pending',
        requestDate: Date.now(),
      };
      appData.requests.push(req);
      saveData();
      depositWithdrawMsg.textContent = `Your ${op} request for ${amount} tokens submitted successfully. Await admin approval.`;
      depositWithdrawMsg.classList.remove('hidden');
      depositWithdrawForm.reset();
      refreshAdminRequests();
    }

    // Admin login
    function adminLogin() {
      let pwd = adminPasswordInput.value.trim();
      if (pwd === appData.adminPassword) {
        adminLoginMsg.textContent = '';
        adminLoginSection.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        refreshAdminRequests();
      } else {
        adminLoginMsg.textContent = 'Incorrect admin password!';
      }
    }

    // Admin logout
    function adminLogout() {
      adminLoginSection.classList.remove('hidden');
      adminPanel.classList.add('hidden');
      adminPasswordInput.value = '';
      adminLoginMsg.textContent = '';
    }

    // Refresh admin requests table
    function refreshAdminRequests() {
      if (!adminPanel.classList.contains('hidden')) {
        requestsTableBody.innerHTML = '';
        if(appData.requests.length === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="5">No requests pending.</td></tr>';
          return;
        }
        appData.requests.forEach(req => {
          if (req.status === 'pending') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>@${req.username}</td>
              <td>${req.operation}</td>
              <td>${req.amount.toFixed(2)}</td>
              <td>${req.status}</td>
              <td>
                <button data-id="${req.id}" class="approveBtn btn-secondary">Approve</button>
                <button data-id="${req.id}" class="rejectBtn btn-danger">Reject</button>
              </td>
            `;
            requestsTableBody.appendChild(tr);
          }
        });
        if(requestsTableBody.childElementCount === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="5">No pending requests.</td></tr>';
        }
      }
    }

    // Admin approve request
    function adminApproveRequest(requestId) {
      const reqIdx = appData.requests.findIndex(r => r.id === requestId);
      if (reqIdx === -1) return;
      let req = appData.requests[reqIdx];
      if (req.status !== 'pending') return;
      let user = appData.users[req.telegram_id];
      if (!user) return;

      if (req.operation === 'deposit') {
        // Admin adds deposit tokens to user balance
        user.balance += req.amount;
      } else if (req.operation === 'withdraw') {
        if (req.amount <= user.balance) {
          user.balance -= req.amount;
        } else {
          alert('Withdrawal amount exceeds user balance.');
          return;
        }
      }
      req.status = 'approved';

      saveData();
      refreshAdminRequests();
      if (appData.currentUserId === user.telegram_id) {
        initUserUI();
      }
    }

    // Admin reject request
    function adminRejectRequest(requestId) {
      const reqIdx = appData.requests.findIndex(r => r.id === requestId);
      if (reqIdx === -1) return;
      let req = appData.requests[reqIdx];
      if (req.status !== 'pending') return;
      req.status = 'rejected';
      saveData();
      refreshAdminRequests();
    }

    // Copy referral link to clipboard
    function copyReferralLink() {
      const text = referralLinkDisplay.textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert('Referral link copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy referral link. Please copy manually.');
      });
    }

    // Event listeners
    document.getElementById('loginTelegramBtn').addEventListener('click', telegramLogin);
    btnLogout.addEventListener('click', logoutUser);

    btnDashboard.addEventListener('click', () => {
      showSection('dashboard');
      calculateWeeklyProfit();
    });
    btnInvest.addEventListener('click', () => {
      investMsg.classList.add('hidden');
      showSection('invest');
    });
    btnRewards.addEventListener('click', () => {
      videoRewardStatus.textContent = '';
      ppcRewardStatus.textContent = '';
      showSection('rewards');
    });
    btnDepositWithdraw.addEventListener('click', () => {
      depositWithdrawMsg.classList.add('hidden');
      depositWithdrawForm.reset();
      showSection('depositWithdraw');
    });
    btnReferral.addEventListener('click', () => {
      showSection('referral');
      initUserUI();
    });
    btnAdmin.addEventListener('click', () => {
      showSection('admin');
      adminLogout();
    });

    backToDashboardFromInvest.addEventListener('click', () => {
      showSection('dashboard');
      calculateWeeklyProfit();
    });
    backToDashboardFromRewards.addEventListener('click', () => showSection('dashboard'));
    backToDashboardFromDW.addEventListener('click', () => showSection('dashboard'));
    backToDashboardFromReferral.addEventListener('click', () => showSection('dashboard'));

    investMsg.classList.add('hidden');

    depositWithdrawForm.addEventListener('submit', submitDepositWithdrawRequest);

    btnWatchAd.addEventListener('click', () => {
      if (rewardVideo.paused) {
        rewardVideo.play();
      } else {
        watchVideoAdReward();
      }
    });

    rewardVideo.addEventListener('ended', () => {
      watchVideoAdReward();
    });

    btnPayPerClick.addEventListener('click', payPerClickReward);

    // Investment package buttons
    document.querySelectorAll('.buyInvestPackage').forEach(btn => {
      btn.addEventListener('click', () => {
        const pkg = btn.getAttribute('data-package');
        const amount = parseFloat(btn.getAttribute('data-amount'));
        const profit = parseFloat(btn.getAttribute('data-profit'));
        buyInvestPackage(pkg, amount, profit);
      });
    });

    // Referral link copy on click
    referralLinkDisplay.addEventListener('click', copyReferralLink);
    referralLinkDisplay.addEventListener('keypress', (evt) => {
      if(evt.key === 'Enter' || evt.key === ' ') {
        copyReferralLink();
      }
    });

    btnAdminLogin.addEventListener('click', adminLogin);
    btnLogoutAdmin.addEventListener('click', () => {
      adminLogout();
      showSection('login');
      showNavBar(false);
      logoutUser();
    });

    requestsTableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('approveBtn')) {
        const reqId = e.target.getAttribute('data-id');
        adminApproveRequest(reqId);
      } else if (e.target.classList.contains('rejectBtn')) {
        const reqId = e.target.getAttribute('data-id');
        adminRejectRequest(reqId);
      }
    });

    // On load
    loadData();
    if(appData.currentUserId) {
      showNavBar(true);
      showSection('dashboard');
      initUserUI();
      calculateWeeklyProfit();
    } else {
      showNavBar(false);
      showSection('login');
    }
  })();
</script>
</body>
</html>

