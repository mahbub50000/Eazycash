<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TapSwap Mini App</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --text-light-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bottom-nav-height: 60px;
            --header-height: 50px;
        }


        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            overflow: hidden; /* Prevent scrollbars on body */
        }


        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            background-color: var(--background-color);
        }


        .page-header {
            height: var(--header-height);
            background-color: var(--surface-color);
            color: var(--primary-color);
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            padding: 0 15px;
            box-sizing: border-box;
        }
        
        .page-content-wrapper {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for page content */
            padding-bottom: var(--bottom-nav-height); /* Space for bottom nav */
        }


        .page {
            display: none; /* Hidden by default */
            flex-direction: column; /* Ensure pages can have internal flex layouts */
            height: 100%; /* Make page take full height of its container */
        }


        .page.active {
            display: flex; /* Show active page */
        }


        .page-content {
            padding: 20px;
            flex-grow: 1;
        }


        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom); /* For iOS notches */
        }


        #bottom-nav button {
            background: none;
            border: none;
            color: var(--secondary-color);
            font-size: 10px;
            cursor: pointer;
            padding: 8px 5px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        #bottom-nav button .icon {
            font-size: 20px; /* Icon size */
            margin-bottom: 4px;
        }


        #bottom-nav button.active {
            color: var(--primary-color);
            font-weight: bold;
        }


        /* Tap Page specific styles */
        #tap-page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }


        #points-display {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        #dog-tap-area {
            width: 150px;
            height: 150px;
            background-color: var(--warning-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em; /* Dog emoji size */
            cursor: pointer;
            user-select: none;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.1s ease-out;
        }
        #dog-tap-area:active {
            transform: scale(0.95);
        }


        #energy-bar-container {
            width: 80%;
            max-width: 300px;
            height: 25px;
            background-color: var(--border-color);
            border-radius: 12.5px;
            overflow: hidden;
            margin-bottom: 10px;
        }


        #energy-bar {
            width: 100%;
            height: 100%;
            background-color: var(--success-color);
            border-radius: 12.5px;
            transition: width 0.2s ease-in-out;
        }


        #energy-text {
            font-size: 0.9em;
            color: var(--text-light-color);
        }


        .floating-point {
            position: absolute;
            font-size: 1.5em;
            color: var(--primary-color);
            opacity: 1;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none; /* So it doesn't interfere with taps */
        }


        @keyframes floatUp {
            to {
                transform: translateY(-50px);
                opacity: 0;
            }
        }


        /* Profile, Task, Withdraw Page common styles */
        .info-item, .task-item, .withdraw-option {
            background-color: var(--surface-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .info-item strong { color: var(--primary-color); }


        /* Task Page specific styles */
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item button {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .task-item button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }


        /* Withdraw Page specific styles */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group select {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
        }
        #withdraw-button {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
        }
        #withdraw-button:disabled {
            background-color: var(--secondary-color);
        }
        .withdraw-details { display: none; }
        .withdraw-details.active { display: block; }


        /* Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 20px); /* Above bottom nav */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            visibility: hidden;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
            bottom: calc(var(--bottom-nav-height) + 30px);
        }


    </style>
</head>
<body>
    <div id="app-container">
        <!-- Profile Page -->
        <div id="profile-page" class="page">
            <div class="page-header">Profile</div>
            <div class="page-content">
                <div class="info-item"><strong>Name:</strong> <span id="profile-name"></span></div>
                <div class="info-item"><strong>User ID:</strong> <span id="profile-userid"></span></div>
                <div class="info-item"><strong>Points:</strong> <span id="profile-points"></span></div>
                <div class="info-item"><strong>Joined:</strong> <span id="profile-join-date"></span></div>
                <div class="info-item"><strong>Referral Code:</strong> <span id="profile-referral"></span></div>
            </div>
        </div>


        <!-- Tap Page -->
        <div id="tap-page" class="page">
            <div class="page-header">TapSwap</div>
            <div class="page-content" id="tap-page-content">
                <div id="points-display">0</div>
                <div id="dog-tap-area">üêï</div>
                <div id="energy-bar-container">
                    <div id="energy-bar"></div>
                </div>
                <div id="energy-text">100/100</div>
            </div>
        </div>


        <!-- Task Page -->
        <div id="task-page" class="page">
            <div class="page-header">Tasks</div>
            <div class="page-content" id="task-list">
                <!-- Tasks will be rendered here by JS -->
            </div>
        </div>


        <!-- Withdraw Page -->
        <div id="withdraw-page" class="page">
            <div class="page-header">Withdraw</div>
            <div class="page-content">
                <div class="info-item"><strong>Available Points:</strong> <span id="withdraw-available-points"></span></div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount to Withdraw:</label>
                    <input type="number" id="withdraw-amount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method:</label>
                    <select id="withdraw-method">
                        <option value="">-- Select Method --</option>
                        <option value="paypal">PayPal</option>
                        <option value="bank">Wire Transfer</option>
                        <option value="crypto">Crypto (USDT)</option>
                    </select>
                </div>
                
                <div id="paypal-details" class="withdraw-details">
                    <div class="form-group">
                        <label for="paypal-email">PayPal Email:</label>
                        <input type="email" id="paypal-email" placeholder="your.email@example.com">
                    </div>
                </div>
                <div id="bank-details" class="withdraw-details">
                    <div class="form-group">
                        <label for="bank-account-name">Account Holder Name:</label>
                        <input type="text" id="bank-account-name" placeholder="Full Name">
                    </div>
                    <div class="form-group">
                        <label for="bank-account-number">Account Number:</label>
                        <input type="text" id="bank-account-number" placeholder="Account Number">
                    </div>
                    <div class="form-group">
                        <label for="bank-swift-code">SWIFT/BIC Code:</label>
                        <input type="text" id="bank-swift-code" placeholder="SWIFT or BIC">
                    </div>
                </div>
                 <div id="crypto-details" class="withdraw-details">
                    <div class="form-group">
                        <label for="crypto-address">USDT Wallet Address (TRC20):</label>
                        <input type="text" id="crypto-address" placeholder="Your TRC20 USDT Address">
                    </div>
                </div>
                <button id="withdraw-button">Withdraw Points</button>
            </div>
        </div>
    </div>


    <nav id="bottom-nav">
        <button data-page="profile-page"><span class="icon">üë§</span>Profile</button>
        <button data-page="tap-page" class="active"><span class="icon">üëÜ</span>Tap</button>
        <button data-page="task-page"><span class="icon">üìù</span>Tasks</button>
        <button data-page="withdraw-page"><span class="icon">üí∏</span>Withdraw</button>
    </nav>


    <div id="toast-notification"></div>


    <script>
        // Mock Telegram WebApp object if not running in Telegram environment
        if (typeof Telegram === 'undefined') {
            window.Telegram = {
                WebApp: {
                    ready: () => console.log("Telegram.WebApp.ready() called (mocked)"),
                    initDataUnsafe: {
                        user: {
                            id: 123456789,
                            first_name: "Demo",
                            last_name: "User",
                            username: "demouser",
                            language_code: "en"
                        }
                    },
                    HapticFeedback: {
                        impactOccurred: (style) => console.log(`Haptic feedback: ${style} (mocked)`),
                        notificationOccurred: (type) => console.log(`Haptic notification: ${type} (mocked)`),
                        selectionChanged: () => console.log(`Haptic selection changed (mocked)`)
                    },
                    expand: () => console.log("WebApp expanded (mocked)"),
                    // You can add more mock methods if needed
                }
            };
            console.log("Telegram WebApp mocked for browser use.");
        }


        // --- Constants ---
        const LOCAL_STORAGE_KEY = 'tapSwapUserData_v3';
        const MAX_ENERGY = 1000;
        const ENERGY_PER_TAP = 10;
        const POINTS_PER_TAP = 1;
        const ENERGY_REFILL_INTERVAL_MS = 1000; // Check every second
        const ENERGY_REFILL_RATE_PER_SECOND = 2; // Energy points refilled per second


        // --- App State ---
        let appState = {
            currentUser: Telegram.WebApp.initDataUnsafe.user || { first_name: "Guest", id: '00000', username: 'guest' },
            points: 0,
            energy: MAX_ENERGY,
            joinDate: new Date().toISOString(),
            referralCode: `REF${(Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : 'DEMOUSER')}`,
            tasks: [
                { id: 'yt1', title: "Watch Intro Video", reward: 1000, completed: false, url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ" },
                { id: 'yt2', title: "Learn Tapping Basics", reward: 1200, completed: false, url: "https://www.youtube.com/watch?v=oHg5SJYRHA0" },
                { id: 'yt3', title: "Understand Energy", reward: 800, completed: false, url: "https://www.youtube.com/watch?v=C0DPdy98e4c" },
                { id: 'yt4', title: "Check Withdrawal Options", reward: 1500, completed: false, url: "https://www.youtube.com/watch?v=V-_O7nl0Ii0" },
                { id: 'yt5', title: "Join Community", reward: 500, completed: false, url: "https://www.youtube.com/watch?v=8ybW48rKBME" }
            ],
            lastEnergyUpdateTimestamp: Date.now(),
            activePage: 'tap-page',
        };


        // --- DOM Elements ---
        const DOMElements = {
            pages: document.querySelectorAll('.page'),
            navButtons: document.querySelectorAll('#bottom-nav button'),
            
            // Profile Page
            profileName: document.getElementById('profile-name'),
            profileUserId: document.getElementById('profile-userid'),
            profilePoints: document.getElementById('profile-points'),
            profileJoinDate: document.getElementById('profile-join-date'),
            profileReferral: document.getElementById('profile-referral'),


            // Tap Page
            pointsDisplay: document.getElementById('points-display'),
            dogTapArea: document.getElementById('dog-tap-area'),
            energyBar: document.getElementById('energy-bar'),
            energyText: document.getElementById('energy-text'),
            tapPageContent: document.getElementById('tap-page-content'),




            // Task Page
            taskList: document.getElementById('task-list'),


            // Withdraw Page
            withdrawAvailablePoints: document.getElementById('withdraw-available-points'),
            withdrawAmountInput: document.getElementById('withdraw-amount'),
            withdrawMethodSelect: document.getElementById('withdraw-method'),
            paypalDetailsDiv: document.getElementById('paypal-details'),
            bankDetailsDiv: document.getElementById('bank-details'),
            cryptoDetailsDiv: document.getElementById('crypto-details'),
            withdrawButton: document.getElementById('withdraw-button'),


            // Toast
            toastNotification: document.getElementById('toast-notification'),
        };


        // --- Local Storage ---
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
        }


        function loadData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Merge tasks carefully: keep existing task structure but update completion status
                const currentTaskIds = new Set(appState.tasks.map(t => t.id));
                const savedTasks = parsedData.tasks.filter(st => currentTaskIds.has(st.id));
                
                // Update completion status from saved data
                appState.tasks.forEach(currentTask => {
                    const savedTask = savedTasks.find(st => st.id === currentTask.id);
                    if (savedTask) {
                        currentTask.completed = savedTask.completed;
                    }
                });


                // Update other state properties
                appState = {
                    ...appState, // Keeps default tasks and currentUser from latest code
                    ...parsedData, // Overwrites with saved data
                    tasks: [...appState.tasks] // Uses the merged tasks
                };


                // Ensure currentUser is up-to-date from Telegram if available
                 appState.currentUser = Telegram.WebApp.initDataUnsafe.user || appState.currentUser;
                 appState.referralCode = `REF${(appState.currentUser.id || 'DEMOUSER')}`;




            } else {
                // If no saved data, use initial appState, which already includes Telegram user if available
                appState.joinDate = new Date().toISOString(); // Set join date to now for new users
                 appState.lastEnergyUpdateTimestamp = Date.now();
            }
            // Always ensure energy isn't stale
            refillEnergy(); // Initial energy calculation based on time passed
        }


        // --- UI Update Functions ---
        function showPage(pageId) {
            appState.activePage = pageId;
            DOMElements.pages.forEach(page => {
                page.classList.toggle('active', page.id === pageId);
            });
            DOMElements.navButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.page === pageId);
            });


            // Render page content when it becomes active
            if (pageId === 'profile-page') renderProfilePage();
            if (pageId === 'task-page') renderTaskPage();
            if (pageId === 'withdraw-page') renderWithdrawPage();
            // Tap page is mostly dynamic, its core elements (points, energy) update constantly
            updatePointsDisplay();
            updateEnergyDisplay();
        }
        
        function updatePointsDisplay() {
            const formattedPoints = Math.floor(appState.points).toLocaleString();
            if (DOMElements.pointsDisplay) DOMElements.pointsDisplay.textContent = formattedPoints;
            if (DOMElements.profilePoints) DOMElements.profilePoints.textContent = formattedPoints;
            if (DOMElements.withdrawAvailablePoints) DOMElements.withdrawAvailablePoints.textContent = formattedPoints;
        }


        function updateEnergyDisplay() {
            const energyPercentage = (appState.energy / MAX_ENERGY) * 100;
            if (DOMElements.energyBar) DOMElements.energyBar.style.width = `${energyPercentage}%`;
            if (DOMElements.energyText) DOMElements.energyText.textContent = `${Math.floor(appState.energy)}/${MAX_ENERGY}`;
        }


        function renderProfilePage() {
            DOMElements.profileName.textContent = `${appState.currentUser.first_name || ''} ${appState.currentUser.last_name || ''}`.trim() || 'N/A';
            DOMElements.profileUserId.textContent = appState.currentUser.id || 'N/A';
            DOMElements.profileJoinDate.textContent = new Date(appState.joinDate).toLocaleDateString();
            DOMElements.profileReferral.textContent = appState.referralCode;
        }


        function renderTaskPage() {
            DOMElements.taskList.innerHTML = ''; // Clear existing tasks
            appState.tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div>
                        <strong>${task.title}</strong><br>
                        <small>Reward: ${task.reward.toLocaleString()} points</small>
                    </div>
                    <button data-task-id="${task.id}" ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? 'Claimed' : 'Complete Task'}
                    </button>
                `;
                const button = taskItem.querySelector('button');
                if (!task.completed) {
                    button.onclick = () => completeTask(task.id);
                }
                DOMElements.taskList.appendChild(taskItem);
            });
        }
        
        function renderWithdrawPage() {
            DOMElements.withdrawAmountInput.value = '';
            DOMElements.withdrawMethodSelect.value = '';
            toggleWithdrawDetails(''); // Hide all detail sections
            updatePointsDisplay(); // Ensure available points is current
        }


        // --- Core Logic ---
        function handleTap(event) {
            refillEnergy(); // Update energy before tap
            if (appState.energy >= ENERGY_PER_TAP) {
                appState.energy -= ENERGY_PER_TAP;
                appState.points += POINTS_PER_TAP;
                
                updatePointsDisplay();
                updateEnergyDisplay();
                saveData();


                try { Telegram.WebApp.HapticFeedback.impactOccurred('light'); } catch (e) { console.error("Haptic error:", e); }


                // Show floating point animation
                const pointsEarnedText = document.createElement('div');
                pointsEarnedText.className = 'floating-point';
                pointsEarnedText.textContent = `+${POINTS_PER_TAP}`;
                
                // Position relative to the tap area or click position
                const rect = DOMElements.dogTapArea.getBoundingClientRect();
                // Use clientX/Y if available from touch/mouse event, otherwise center of dog tap area
                const x = event.clientX || (rect.left + rect.width / 2);
                const y = event.clientY || (rect.top + rect.height / 2);


                pointsEarnedText.style.left = `${x - rect.left}px`; // Position within tap-page-content
                pointsEarnedText.style.top = `${y - rect.top - DOMElements.pointsDisplay.offsetHeight - 20}px`; // Adjust to appear above dog


                DOMElements.tapPageContent.appendChild(pointsEarnedText);
                setTimeout(() => {
                    pointsEarnedText.remove();
                }, 1000);


            } else {
                showToast("Not enough energy!");
            }
        }


        function refillEnergy() {
            const now = Date.now();
            const timeElapsedSeconds = (now - appState.lastEnergyUpdateTimestamp) / 1000;
            const energyToRefill = timeElapsedSeconds * ENERGY_REFILL_RATE_PER_SECOND;


            if (energyToRefill > 0) {
                appState.energy = Math.min(MAX_ENERGY, appState.energy + energyToRefill);
                appState.lastEnergyUpdateTimestamp = now;
                updateEnergyDisplay();
                saveData(); // Save data less frequently for energy refills to avoid too many writes
            }
        }
        
        setInterval(() => {
            if (appState.energy < MAX_ENERGY) {
                refillEnergy();
            }
        }, ENERGY_REFILL_INTERVAL_MS);




        function completeTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                task.completed = true;
                appState.points += task.reward;
                
                updatePointsDisplay();
                renderTaskPage(); // Re-render tasks to update button state
                saveData();
                showToast(`Task "${task.title}" completed! +${task.reward} points.`);
                try { Telegram.WebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { console.error("Haptic error:", e); }
            }
        }


        function toggleWithdrawDetails(method) {
            DOMElements.paypalDetailsDiv.classList.toggle('active', method === 'paypal');
            DOMElements.bankDetailsDiv.classList.toggle('active', method === 'bank');
            DOMElements.cryptoDetailsDiv.classList.toggle('active', method === 'crypto');
        }


        DOMElements.withdrawMethodSelect.addEventListener('change', (event) => {
            toggleWithdrawDetails(event.target.value);
        });
        
        function handleWithdrawal() {
            const amount = parseFloat(DOMElements.withdrawAmountInput.value);
            const method = DOMElements.withdrawMethodSelect.value;


            if (isNaN(amount) || amount <= 0) {
                showToast("Please enter a valid amount.", "error");
                return;
            }
            if (amount > appState.points) {
                showToast("Insufficient points.", "error");
                return;
            }
            if (!method) {
                showToast("Please select a withdrawal method.", "error");
                return;
            }


            // Basic validation for selected method fields (can be expanded)
            let detailsFilled = true;
            if (method === 'paypal' && !document.getElementById('paypal-email').value) detailsFilled = false;
            if (method === 'bank' && (!document.getElementById('bank-account-name').value || !document.getElementById('bank-account-number').value)) detailsFilled = false;
            if (method === 'crypto' && !document.getElementById('crypto-address').value) detailsFilled = false;
            
            if (!detailsFilled) {
                showToast("Please fill in all required details for the selected method.", "error");
                return;
            }


            // Simulate withdrawal
            appState.points -= amount;
            updatePointsDisplay();
            saveData();
            
            DOMElements.withdrawAmountInput.value = ''; // Clear input
            showToast(`Withdrawal of ${amount.toLocaleString()} points via ${method} initiated. (This is a simulation)`, "success");
            try { Telegram.WebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { console.error("Haptic error:", e); }
        }


        let toastTimeout;
        function showToast(message, type = 'info') { // type can be 'info', 'success', 'error'
            DOMElements.toastNotification.textContent = message;
            DOMElements.toastNotification.className = 'show'; // Reset classes then add 'show'
            
            // Optional: Add type-specific styling if needed via classes
            // DOMElements.toastNotification.classList.add(type); 


            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                DOMElements.toastNotification.className = '';
                // DOMElements.toastNotification.classList.remove(type);
            }, 3000);
        }


        // --- Initialization ---
        function init() {
            Telegram.WebApp.ready(); // Inform Telegram API that the app is ready
            try { Telegram.WebApp.expand(); } catch (e) { console.error("Expand error:", e); }




            loadData(); // Load saved data or set defaults


            // Setup Navigation
            DOMElements.navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showPage(button.dataset.page);
                });
            });


            // Setup Tap Action
            DOMElements.dogTapArea.addEventListener('click', handleTap); // Pass event for click coordinates
            DOMElements.dogTapArea.addEventListener('touchstart', (e) => { // Prevent double tap zoom on mobile
                e.preventDefault();
                handleTap(e.touches[0]); // Pass touch event for coordinates
            }, { passive: false });




            // Setup Withdraw Action
            DOMElements.withdrawButton.addEventListener('click', handleWithdrawal);
            
            // Initial Page Load
            showPage(appState.activePage || 'tap-page'); // Show last active page or default to tap


            // Initial UI updates
            updatePointsDisplay();
            updateEnergyDisplay();
            refillEnergy(); // Recalculate energy based on time since last open


            console.log("TapSwap App Initialized");
            console.log("Current User:", appState.currentUser);
            console.log("Current State:", appState);
        }


        // --- Start the app ---
        // Use DOMContentLoaded for browsers, Telegram.WebApp.ready() handles its own timing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init(); // DOMContentLoaded has already fired
        }


    </script>
</body>
</html>
