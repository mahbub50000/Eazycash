<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Mini App - Investment & Rewards</title>
<style>
  /* Modern clean Telegram inspired UI */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Inter', sans-serif;
    background: #F3F6FB;
    color: #1A1A1A;
  }
  #app {
    max-width: 480px;
    margin: auto;
    background: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  header {
    background: #2AABEE;
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    font-size: 1.3rem;
    text-align: center;
    box-shadow: inset 0 -1px 0 rgba(255 255 255 / 0.3);
  }
  nav {
    display: flex;
    background: #E6F7FF;
    border-bottom: 1px solid #B3E5FC;
  }
  nav button {
    flex: 1;
    border: none;
    background: none;
    padding: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    color: #2AABEE;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: border-color 0.3s;
  }
  nav button.active {
    border-bottom: 3px solid #2AABEE;
    background: white;
    font-weight: 700;
  }
  main {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px 20px;
  }
  .section {
    display: none;
  }
  .section.active {
    display: block;
  }
  h2 {
    color: #179CD7;
    font-weight: 700;
    margin-bottom: 10px;
  }
  .info-box {
    background: #E6F7FF;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    color: #0B72B9;
    font-weight: 600;
  }
  .btn {
    background: #2AABEE;
    color: white;
    border: none;
    padding: 10px 18px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    user-select: none;
    transition: background 0.3s;
  }
  .btn:hover:not(:disabled) {
    background: #1e90d9;
  }
  .btn:disabled {
    background: #a0d5fb;
    cursor: not-allowed;
  }
  input[type="text"], input[type="number"], input[type="password"] {
    width: 100%;
    padding: 8px 10px;
    margin: 5px 0 10px 0;
    box-sizing: border-box;
    border: 1.5px solid #b3e5fc;
    border-radius: 5px;
    font-size: 1rem;
    color: #1a1a1a;
  }
  label {
    font-weight: 600;
    display: block;
    margin-top: 10px;
    margin-bottom: 4px;
    color: #179cd7;
  }
  .reward-item, .investment-item, .transaction-item, .user-item {
    background: #eef9ff;
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.07);
  }
  .reward-item > div, .investment-item > div, .transaction-item > div, .user-item > div {
    margin-bottom: 6px;
  }
  .small-button {
    background: #179CD7;
    font-size: 0.8rem;
    padding: 6px 10px;
    margin-left: 10px;
    border-radius: 5px;
    user-select: none;
  }
  .small-button:hover {
    background: #117abb;
  }
  .flex-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .inline {
    display: inline-block;
  }
  .success-msg {
    color: #2ABA6D;
    font-weight: 600;
  }
  .error-msg {
    color: #d9534f;
    font-weight: 600;
  }
  footer {
    padding: 10px 20px;
    background: #E6F7FF;
    color: #0B72B9;
    font-size: 0.9rem;
    text-align: center;
  }
  a {
    color: #1e90d9;
    text-decoration: none;
    font-weight: 600;
  }
  a:hover {
    text-decoration: underline;
  }
  .admin-warning {
    background: #ffdede;
    border-radius: 8px;
    padding: 10px 15px;
    color: #d9534f;
    font-weight: 700;
    margin-bottom: 15px;
  }
  .status-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .status-pending {
    background: #ffe699;
    color: #a67c00;
  }
  .status-approved {
    background: #c6efce;
    color: #256029;
  }
  .status-rejected {
    background: #f8d7da;
    color: #721c24;
  }
</style>
</head>
<body>
<div id="app">
  <header>
    Telegram Mini App Investment & Rewards
  </header>
  <nav>
    <button class="active" data-tab="profile">Profile</button>
    <button data-tab="referrals">Referral</button>
    <button data-tab="rewards">Rewards</button>
    <button data-tab="investment">Investment</button>
    <button data-tab="finance">Deposit/Withdraw</button>
    <button data-tab="admin">Admin Panel</button>
  </nav>
  <main>
    <!-- Profile tab -->
    <section class="section active" id="profile-section">
      <h2>Welcome</h2>
      <div id="welcome-msg" class="info-box">Loading user info...</div>
      <div><strong>Telegram User ID:</strong> <span id="user-id-display"></span></div>
      <div><strong>Balance:</strong> $<span id="balance-display">0.00</span></div>
      <div><strong>Bonus Balance:</strong> $<span id="bonus-balance-display">0.00</span></div>
      <div><strong>Total Referral Bonus:</strong> $<span id="total-referral-bonus">0.00</span></div>
      <div><strong>Total Profit Earned:</strong> $<span id="total-profit-earned">0.00</span></div>
    </section>

    <!-- Referral tab -->
    <section class="section" id="referrals-section">
      <h2>Referral Program</h2>
      <div>
        Share your referral link to earn bonuses when your friends join:
      </div>
      <div style="margin: 12px 0; padding: 10px; background: #dff6ff; border-radius: 6px; font-weight: 700; color: #0b72b9;">
        <input type="text" readonly id="referral-link" style="width:100%; border:none; background:none; font-weight: 700; color:#0b72b9; cursor: pointer;" />
      </div>
      <button class="btn" id="copy-ref-link">Copy Referral Link</button>
      <h3 style="margin-top: 20px;">Your Referrals</h3>
      <ul id="referral-list" style="list-style:none; padding-left:0;"></ul>
    </section>

    <!-- Rewards tab -->
    <section class="section" id="rewards-section">
      <h2>Rewards</h2>
      <div class="reward-item">
        <div><strong>Watch Video Ad</strong></div>
        <div>Earn $0.50 bonus for each video ad watched.</div>
        <button class="btn" id="watch-video-ad">Watch Video Ad</button>
      </div>
      <div class="reward-item">
        <div><strong>Pay Per Click Ads</strong></div>
        <div>Earn $0.10 bonus for each ad clicked.</div>
        <button class="btn" id="click-ad">Click an Ad</button>
      </div>
      <div id="rewards-msg" style="margin-top: 12px;"></div>
    </section>

    <!-- Investment tab -->
    <section class="section" id="investment-section">
      <h2>Investment Package</h2>
      <div>
        <p>
          Invest your balance in the weekly package to earn 10% profit every 7 days.
          Your investment will be locked for 7 days. After that, you can withdraw your profit and principal.
        </p>
      </div>
      <div>
        <label for="investment-amount">Investment Amount ($):</label>
        <input type="number" id="investment-amount" min="10" step="1" placeholder="Minimum $10" />
        <button class="btn" id="make-investment">Invest</button>
      </div>
      <h3 style="margin-top: 20px;">Active Investments</h3>
      <div id="investment-list"></div>
    </section>

   <!-- Deposit & Withdraw tab -->
<section class="section" id="finance-section">
  <h2>Deposit & Withdrawal</h2>
  <div style="margin-bottom: 20px;">
    <h3>Request Deposit</h3>
    <label for="deposit-amount">Deposit Amount ($):</label>
    <input type="number" id="deposit-amount" min="1" step="1" placeholder="Enter deposit amount" />
    <button class="btn" id="request-deposit">Request Deposit</button>
    <div id="deposit-msg"></div>
  </div>
  <div>
    <h3>Request Withdrawal</h3>
    <label for="withdraw-amount">Withdrawal Amount ($):</label>
    <input type="number" id="withdraw-amount" min="1" step="1" placeholder="Enter withdrawal amount" />
    <button class="btn" id="make-withdrawal">Request Withdrawal</button>
    <div id="withdraw-msg"></div>
  </div>

  <h3 style="margin-top: 30px;">Deposit Requests</h3>
  <ul id="deposit-requests-list" style="list-style:none; padding-left:0; margin-bottom: 20px;"></ul>

  <h3 style="margin-top: 10px;">Withdrawal Requests</h3>
  <ul id="withdrawal-requests-list" style="list-style:none; padding-left:0;"></ul>
</section>

<script>
  // Deposit and Withdrawal functions

  function updateDepositsWithdrawalsUI() {
    const user = getCurrentUser ();
    if (!user) return;

    // Deposit requests list for user
    const depositList = document.getElementById('deposit-requests-list');
    depositList.innerHTML = '';

    if (!user.deposits.length) {
      depositList.innerHTML = '<li>No deposit requests.</li>';
    } else {
      user.deposits.forEach(dep => {
        const li = document.createElement('li');
        li.className = 'transaction-item';
        let statusClass = '';
        if(dep.status === 'pending') statusClass = 'status-pending';
        else if(dep.status === 'approved') statusClass = 'status-approved';
        else if(dep.status === 'rejected') statusClass = 'status-rejected';

        li.innerHTML = `
          Amount: $${formatMoney(dep.amount)} 
          <span class="status-badge ${statusClass}">${dep.status.charAt(0).toUpperCase() + dep.status.slice(1)}</span><br />
          Requested on: ${new Date(dep.timestamp).toLocaleString()}
        `;
        depositList.appendChild(li);
      });
    }

    // Withdrawal requests list for user
    const withdrawList = document.getElementById('withdrawal-requests-list');
    withdrawList.innerHTML = '';
    const pendingWithdrawals = user.withdrawals.filter(w => w.status === 'pending');
    if (!pendingWithdrawals.length) {
      withdrawList.innerHTML = '<li>No pending withdrawal requests.</li>';
    } else {
      pendingWithdrawals.forEach(w => {
        const li = document.createElement('li');
        li.className = 'transaction-item';
        li.textContent = `Amount: $${formatMoney(w.amount)} | Requested on: ${new Date(w.timestamp).toLocaleString()}`;
        withdrawList.appendChild(li);
      });
    }
  }

  function setupDepositWithdrawHandlers() {
    const depositBtn = document.getElementById('request-deposit');
    const depositMsg = document.getElementById('deposit-msg');
    depositBtn.onclick = () => {
      depositMsg.textContent = '';
      const amount = parseFloat(document.getElementById('deposit-amount').value);
      const user = getCurrentUser ();
      if (!user) {
        depositMsg.textContent = 'User  not found.';
        depositMsg.className = 'error-msg';
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        depositMsg.textContent = 'Enter a valid deposit amount.';
        depositMsg.className = 'error-msg';
        return;
      }
      // Add deposit request with status pending, no balance increase yet
      user.deposits.push({
        amount,
        timestamp: Date.now(),
        status: 'pending',
      });
      saveAppData();
      updateDepositsWithdrawalsUI();
      depositMsg.textContent = `Deposit request for $${formatMoney(amount)} submitted for approval.`;
      depositMsg.className = 'success-msg';
      document.getElementById('deposit-amount').value = '';
    };

    const withdrawBtn = document.getElementById('make-withdrawal');
    const withdrawMsg = document.getElementById('withdraw-msg');
    withdrawBtn.onclick = () => {
      withdrawMsg.textContent = '';
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      const user = getCurrentUser ();
      if (!user) {
        withdrawMsg.textContent = 'User  not found.';
        withdrawMsg.className = 'error-msg';
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        withdrawMsg.textContent = 'Enter a valid withdrawal amount.';
        withdrawMsg.className = 'error-msg';
        return;
      }
      if (amount > user.balance + user.bonusBalance) {
        withdrawMsg.textContent = 'Insufficient total balance (balance + bonus) to withdraw this amount.';
        withdrawMsg.className = 'error-msg';
        return;
      }

      // Withdrawal requests deduct from regular balance first, then bonus balance if needed
      let remaining = amount;
      if (user.balance >= remaining) {
        user.balance -= remaining;
        remaining = 0;
      } else {
        remaining -= user.balance;
        user.balance = 0;
      }
      if (remaining > 0) {
        if (user.bonusBalance >= remaining) {
          user.bonusBalance -= remaining;
          remaining = 0;
        } else {
          withdrawMsg.textContent = 'Unexpected error due to insufficient funds.';
          withdrawMsg.className = 'error-msg';
          return;
        }
      }

      const withdrawalRequest = {
        amount,
        timestamp: Date.now(),
        status: 'pending',
        userId: user.id,
      };
      user.withdrawals.push(withdrawalRequest);
      appData.users[user.id] = user;
      saveAppData();
      updateProfileUI(user);
      updateDepositsWithdrawalsUI();
      withdrawMsg.textContent = `Withdrawal request for $${formatMoney(amount)} submitted for approval.`;
      withdrawMsg.className = 'success-msg';
      document.getElementById('withdraw-amount').value = '';
    };
  }

  // Admin panel functionality

  function updateAdminDepositsList() {
    const ul = document.getElementById('admin-deposits-list');
    ul.innerHTML = '';
    let found = false;
    Object.values(appData.users).forEach(user => {
      user.deposits.forEach(d => {
        if (d.status === 'pending') {
          found = true;
          const li = document.createElement('li');
          li.className = 'transaction-item';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.marginBottom = '12px';

          li.innerHTML = `
            <div>
              <strong>User ID: ${user.id}</strong><br />
              Amount: $${formatMoney(d.amount)}<br />
              Requested on: ${new Date(d.timestamp).toLocaleString()}
            </div>
          `;
          const actionsDiv = document.createElement('div');

          const approveBtn = document.createElement('button');
          approveBtn.className = 'small-button';
          approveBtn.textContent = 'Approve';
          approveBtn.style.background = '#2ABA6D';
          approveBtn.style.marginRight = '8px';
          approveBtn.onclick = () => {
            // Approve deposit: mark status approved, add amount to balance
            d.status = 'approved';
            user.balance += d.amount;
            saveAppData();
            alert(`Deposit of $${formatMoney(d.amount)} approved for User ID ${user.id}.`);
            updateAdminDepositsList();
            updateDepositsWithdrawalsUI();
            updateProfileUI(getCurrentUser ());
          };

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'small-button';
          rejectBtn.textContent = 'Reject';
          rejectBtn.style.background = '#d9534f';
          rejectBtn.onclick = () => {
            // Reject deposit: mark rejected without balance addition
            if (d.status !== 'pending') return;
            d.status = 'rejected';
            saveAppData();
            alert(`Deposit of $${formatMoney(d.amount)} rejected for User ID ${user.id}.`);
            updateAdminDepositsList();
            updateDepositsWithdrawalsUI();
          };

          actionsDiv.appendChild(approveBtn);
          actionsDiv.appendChild(rejectBtn);
          li.appendChild(actionsDiv);
          ul.appendChild(li);
        }
      });
    });
    if (!found) {
      ul.innerHTML = '<li>No pending deposit requests.</li>';
    }
  }


    <!-- Admin Panel tab -->
    <section class="section" id="admin-section">
      <h2>Admin Panel</h2>
      <div id="admin-login-section">
        <p><strong>Admin Access Required</strong></p>
        <label for="admin-password">Enter Admin Password:</label>
        <input type="password" id="admin-password" placeholder="Admin password" />
        <button class="btn" id="admin-login-button">Login</button>
        <div id="admin-login-msg"></div>
      </div>
      <div id="admin-panel" style="display:none;">
        <div class="admin-warning">
          <strong>Warning:</strong> Admin Mode Enabled. Handle with care.
        </div>
        <h3>Users</h3>
        <ul id="admin-users-list" style="list-style:none; padding-left:0; max-height: 200px; overflow-y: auto;"></ul>
        <h3>Pending Deposit Requests</h3>
        <ul id="admin-deposits-list" style="list-style:none; padding-left:0; max-height: 200px; overflow-y: auto; margin-bottom: 20px;"></ul>
        <h3>Pending Withdrawal Requests</h3>
        <ul id="admin-withdrawals-list" style="list-style:none; padding-left:0; max-height: 200px; overflow-y: auto;"></ul>
      </div>
    </section>
  </main>
  <footer>
    &copy; 2024 Telegram Mini App Investment System
  </footer>
</div>

<script>
  // Telegram Mini App simulation (replace with actual Telegram API calls in deployment)
  // For development/testing, simulate Telegram login data
  const telegramMockUser = {
    id: '123456789',
    first_name: 'John',
    last_name: 'Doe',
    username: 'john_doe',
  };

  // Admin password (should be more secure in real backend)
  const ADMIN_PASSWORD = "admin123";

  // Utility: format number as currency string
  function formatMoney(num) {
    return num.toFixed(2);
  }

  // Parse URL query parameter (for referral)
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // State variables and localStorage keys
  const LS_KEY = 'telegram_mini_app_data_v2';

  // Load stored data or default
  let appData = {
    users: {}, // userId -> {id, firstName, lastName, username, balance, bonusBalance, referrals:[], referralBonusTotal, totalProfit, investRecords:[], deposits:[], withdrawals:[]}
    currentUserId: null,
  };

  function saveAppData() {
    localStorage.setItem(LS_KEY, JSON.stringify(appData));
  }

  function loadAppData() {
    const data = localStorage.getItem(LS_KEY);
    if (data) {
      appData = JSON.parse(data);
    }
  }

  // Initialize user from Telegram login
  function initUser(telegramUserInfo) {
    loadAppData();
    let user = appData.users[telegramUserInfo.id];
    if (!user) {
      // Create new user
      user = {
        id: telegramUserInfo.id,
        firstName: telegramUserInfo.first_name || '',
        lastName: telegramUserInfo.last_name || '',
        username: telegramUserInfo.username || '',
        balance: 0,
        bonusBalance: 0,
        referrals: [],
        referralBonusTotal: 0,
        totalProfit: 0,
        investRecords: [],
        deposits: [],
        withdrawals: [],
        joined: Date.now(),
      };

      // Referral bonus if ?ref=someid and referrer exists and is not self
      const referralId = getQueryParam('ref');
      if (referralId && referralId !== telegramUserInfo.id && appData.users[referralId]) {
        // Award referrer some bonus
        appData.users[referralId].bonusBalance += 5;
        appData.users[referralId].referrals.push(user.id);
        appData.users[referralId].referralBonusTotal += 5;
        saveAppData();
        // Also give new user a joining bonus
        user.bonusBalance += 2;
      }

      appData.users[user.id] = user;
      saveAppData();
    }
    appData.currentUserId = user.id;
    saveAppData();
    return user;
  }

  // Get current user object
  function getCurrentUser() {
    if (!appData.currentUserId) return null;
    return appData.users[appData.currentUserId] || null;
  }

  // Update UI display for profile
  function updateProfileUI(user) {
    if (!user) {
      document.getElementById('welcome-msg').textContent = 'User data not found.';
      return;
    }
    let fullname = user.firstName || '';
    if (user.lastName) fullname += ' ' + user.lastName;
    if (!fullname.trim()) fullname = 'User';
    document.getElementById('welcome-msg').textContent = `Welcome back, ${fullname}!`;
    document.getElementById('user-id-display').textContent = user.id;
    document.getElementById('balance-display').textContent = formatMoney(user.balance);
    document.getElementById('bonus-balance-display').textContent = formatMoney(user.bonusBalance);
    document.getElementById('total-referral-bonus').textContent = formatMoney(user.referralBonusTotal);
    document.getElementById('total-profit-earned').textContent = formatMoney(user.totalProfit);
  }

  // Generate referral link for current user
  function getReferralLink(user) {
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}?ref=${user.id}`;
  }

  // Update referral UI
  function updateReferralUI(user) {
    const refLinkInput = document.getElementById('referral-link');
    if (!user) {
      refLinkInput.value = '';
      return;
    }
    refLinkInput.value = getReferralLink(user);
    const referralListUl = document.getElementById('referral-list');
    referralListUl.innerHTML = '';
    if (!user.referrals.length) {
      referralListUl.innerHTML = '<li>No referrals yet.</li>';
    } else {
      user.referrals.forEach(refId => {
        const refUser = appData.users[refId];
        if (refUser) {
          const li = document.createElement('li');
          li.textContent = `${refUser.firstName || ''} ${refUser.lastName || ''} (${refUser.username || 'no username'})`;
          referralListUl.appendChild(li);
        }
      });
    }
  }

  // Copy referral link button handler
  function setupReferralCopyButton() {
    const btn = document.getElementById('copy-ref-link');
    btn.onclick = () => {
      const refLinkInput = document.getElementById('referral-link');
      refLinkInput.select();
      refLinkInput.setSelectionRange(0, 99999);
      try {
        document.execCommand('copy');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Referral Link'; }, 2000);
      } catch (e) {
        alert('Failed to copy referral link.');
      }
    };
  }

  // Rewards system
  function setupRewardsHandlers() {
    const watchBtn = document.getElementById('watch-video-ad');
    const clickBtn = document.getElementById('click-ad');
    const rewardsMsg = document.getElementById('rewards-msg');

    watchBtn.onclick = () => {
      watchBtn.disabled = true;
      rewardsMsg.textContent = 'Playing video ad...';
      // Simulate video ad duration 5 seconds
      setTimeout(() => {
        const user = getCurrentUser();
        if (user) {
          user.bonusBalance += 0.5;
          saveAppData();
          updateProfileUI(user);
          rewardsMsg.innerHTML = '<span class="success-msg">Video ad watched! $0.50 bonus added.</span>';
        }
        watchBtn.disabled = false;
      }, 5000);
    };

    clickBtn.onclick = () => {
      // Simulate ad click
      const user = getCurrentUser();
      if (user) {
        user.bonusBalance += 0.1;
        saveAppData();
        updateProfileUI(user);
        rewardsMsg.innerHTML = '<span class="success-msg">Ad clicked! $0.10 bonus added.</span>';
      }
    };
  }

  // Investment logic
  // Profit is 10% after 7 days from investment timestamp, investment locked during this period

  function updateInvestmentUI() {
    const investmentListDiv = document.getElementById('investment-list');
    investmentListDiv.innerHTML = '';
    const user = getCurrentUser();
    if (!user) return;

    // Clean withdrawn investments from active list
    user.investRecords = user.investRecords.filter(inv => inv.status !== 'withdrawn');

    if (!user.investRecords.length) {
      investmentListDiv.innerHTML = '<p>No active investments.</p>';
      return;
    }

    const now = Date.now();

    user.investRecords.forEach((inv, idx) => {
      const investedAt = inv.timestamp;
      const lockedUntil = investedAt + 7 * 24 * 60 * 60 * 1000; // 7 days
      let profit = 0;
      let profitEarned = 0;
      if (now >= lockedUntil && inv.status === 'active') {
        // Profit 10%
        profit = inv.amount * 0.10;
        profitEarned = profit;
      }
      const container = document.createElement('div');
      container.className = 'investment-item';
      container.innerHTML = 
        `<div><strong>Investment $${formatMoney(inv.amount)}</strong></div>
         <div>Invested on: ${new Date(investedAt).toLocaleString()}</div>
         <div>Locked until: ${new Date(lockedUntil).toLocaleString()}</div>
         <div>Profit after 7 days: $${formatMoney(inv.amount * 0.10)}</div>
         <div>Status: ${inv.status === 'active' ? (now >= lockedUntil ? 'Ready to withdraw' : 'Active (Locked)') : inv.status}</div>
      `;

      if (inv.status === 'active' && now >= lockedUntil) {
        const withdrawBtn = document.createElement('button');
        withdrawBtn.className = 'small-button';
        withdrawBtn.textContent = 'Withdraw Investment+Profit';
        withdrawBtn.onclick = () => {
          // Add investment + profit to balance
          user.balance += inv.amount + profitEarned;
          user.totalProfit += profitEarned;
          inv.status = 'withdrawn';
          saveAppData();
          updateProfileUI(user);
          updateInvestmentUI();
          alert(`Investment and profit $${formatMoney(inv.amount + profitEarned)} withdrawn to your balance.`);
        };
        container.appendChild(withdrawBtn);
      }

      investmentListDiv.appendChild(container);
    });
    saveAppData();
  }

  // Investment button handler
  function setupInvestmentHandler() {
    document.getElementById('make-investment').onclick = () => {
      const amtInput = document.getElementById('investment-amount');
      const amount = parseFloat(amtInput.value);
      const user = getCurrentUser();
      if (!user) return alert('User not found.');
      if (isNaN(amount) || amount < 10) return alert('Please enter a valid amount of at least $10.');
      if (user.balance < amount) return alert('Insufficient balance to invest.');
      // Deduct balance and add investment
      user.balance -= amount;
      const investRecord = {
        amount,
        timestamp: Date.now(),
        status: 'active',
      };
      user.investRecords.push(investRecord);
      saveAppData();
      updateProfileUI(user);
      updateInvestmentUI();
      amtInput.value = '';
      alert(`Invested $${formatMoney(amount)} in the weekly package.`);
    };
  }

  // Deposit and Withdrawal functions

  function updateDepositsWithdrawalsUI() {
    const user = getCurrentUser();
    if (!user) return;

    // Deposit requests list for user
    const depositList = document.getElementById('deposit-requests-list');
    depositList.innerHTML = '';

    if (!user.deposits.length) {
      depositList.innerHTML = '<li>No deposit requests.</li>';
    } else {
      user.deposits.forEach(dep => {
        const li = document.createElement('li');
        li.className = 'transaction-item';
        let statusClass = '';
        if(dep.status === 'pending') statusClass = 'status-pending';
        else if(dep.status === 'approved') statusClass = 'status-approved';
        else if(dep.status === 'rejected') statusClass = 'status-rejected';

        li.innerHTML = `
          Amount: $${formatMoney(dep.amount)} 
          <span class="status-badge ${statusClass}">${dep.status.charAt(0).toUpperCase() + dep.status.slice(1)}</span><br />
          Requested on: ${new Date(dep.timestamp).toLocaleString()}
        `;
        depositList.appendChild(li);
      });
    }

    // Withdrawal requests list for user
    const withdrawList = document.getElementById('withdrawal-requests-list');
    withdrawList.innerHTML = '';
    const pendingWithdrawals = user.withdrawals.filter(w => w.status === 'pending');
    if (!pendingWithdrawals.length) {
      withdrawList.innerHTML = '<li>No pending withdrawal requests.</li>';
    } else {
      pendingWithdrawals.forEach(w => {
        const li = document.createElement('li');
        li.className = 'transaction-item';
        li.textContent = `Amount: $${formatMoney(w.amount)} | Requested on: ${new Date(w.timestamp).toLocaleString()}`;
        withdrawList.appendChild(li);
      });
    }
  }

  function setupDepositWithdrawHandlers() {
    const depositBtn = document.getElementById('request-deposit');
    const depositMsg = document.getElementById('deposit-msg');
    depositBtn.onclick = () => {
      depositMsg.textContent = '';
      const amount = parseFloat(document.getElementById('deposit-amount').value);
      const user = getCurrentUser();
      if (!user) {
        depositMsg.textContent = 'User not found.';
        depositMsg.className = 'error-msg';
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        depositMsg.textContent = 'Enter a valid deposit amount.';
        depositMsg.className = 'error-msg';
        return;
      }
      // Add deposit request with status pending, no balance increase yet
      user.deposits.push({
        amount,
        timestamp: Date.now(),
        status: 'pending',
      });
      saveAppData();
      updateDepositsWithdrawalsUI();
      depositMsg.textContent = `Deposit request for $${formatMoney(amount)} submitted for approval.`;
      depositMsg.className = 'success-msg';
      document.getElementById('deposit-amount').value = '';
    };

    const withdrawBtn = document.getElementById('make-withdrawal');
    const withdrawMsg = document.getElementById('withdraw-msg');
    withdrawBtn.onclick = () => {
      withdrawMsg.textContent = '';
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      const user = getCurrentUser();
      if (!user) {
        withdrawMsg.textContent = 'User not found.';
        withdrawMsg.className = 'error-msg';
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        withdrawMsg.textContent = 'Enter a valid withdrawal amount.';
        withdrawMsg.className = 'error-msg';
        return;
      }
      if (amount > user.balance + user.bonusBalance) {
        withdrawMsg.textContent = 'Insufficient total balance (balance + bonus) to withdraw this amount.';
        withdrawMsg.className = 'error-msg';
        return;
      }

      // Withdrawal requests deduct from regular balance first, then bonus balance if needed
      let remaining = amount;
      if (user.balance >= remaining) {
        user.balance -= remaining;
        remaining = 0;
      } else {
        remaining -= user.balance;
        user.balance = 0;
      }
      if (remaining > 0) {
        if (user.bonusBalance >= remaining) {
          user.bonusBalance -= remaining;
          remaining = 0;
        } else {
          withdrawMsg.textContent = 'Unexpected error due to insufficient funds.';
          withdrawMsg.className = 'error-msg';
          return;
        }
      }

      const withdrawalRequest = {
        amount,
        timestamp: Date.now(),
        status: 'pending',
        userId: user.id,
      };
      user.withdrawals.push(withdrawalRequest);
      appData.users[user.id] = user;
      saveAppData();
      updateProfileUI(user);
      updateDepositsWithdrawalsUI();
      withdrawMsg.textContent = `Withdrawal request for $${formatMoney(amount)} submitted for approval.`;
      withdrawMsg.className = 'success-msg';
      document.getElementById('withdraw-amount').value = '';
    };
  }

  // Admin panel functionality

  let isAdminLoggedIn = false;

  function updateAdminUsersList() {
    const ul = document.getElementById('admin-users-list');
    ul.innerHTML = '';
    Object.values(appData.users).forEach(user => {
      const li = document.createElement('li');
      li.className = 'user-item';
      li.innerHTML = `
        <div><strong>${user.firstName || ''} ${user.lastName || ''} (${user.username || 'no username'})</strong></div>
        <div>User ID: ${user.id}</div>
        <div>Balance: $${formatMoney(user.balance)}, Bonus: $${formatMoney(user.bonusBalance)}</div>
        <div>Referrals: ${user.referrals.length}, Referral Bonus: $${formatMoney(user.referralBonusTotal)}</div>
        <div>Total Profit: $${formatMoney(user.totalProfit)}</div>
      `;
      ul.appendChild(li);
    });
  }

  function updateAdminDepositsList() {
    const ul = document.getElementById('admin-deposits-list');
    ul.innerHTML = '';
    let found = false;
    Object.values(appData.users).forEach(user => {
      user.deposits.forEach(d => {
        if (d.status === 'pending') {
          found = true;
          const li = document.createElement('li');
          li.className = 'transaction-item';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.marginBottom = '12px';

          li.innerHTML = `
            <div>
              <strong>User ID: ${user.id}</strong><br />
              Amount: $${formatMoney(d.amount)}<br />
              Requested on: ${new Date(d.timestamp).toLocaleString()}
            </div>
          `;
          const actionsDiv = document.createElement('div');

          const approveBtn = document.createElement('button');
          approveBtn.className = 'small-button';
          approveBtn.textContent = 'Approve';
          approveBtn.style.background = '#2ABA6D';
          approveBtn.style.marginRight = '8px';
          approveBtn.onclick = () => {
            // Approve deposit: mark status approved, add amount to balance
            d.status = 'approved';
            user.balance += d.amount;
            saveAppData();
            alert(`Deposit of $${formatMoney(d.amount)} approved for User ID ${user.id}.`);
            updateAdminDepositsList();
            updateDepositsWithdrawalsUI();
            updateProfileUI(getCurrentUser());
          };

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'small-button';
          rejectBtn.textContent = 'Reject';
          rejectBtn.style.background = '#d9534f';
          rejectBtn.onclick = () => {
            // Reject deposit: mark rejected without balance addition
            if (d.status !== 'pending') return;
            d.status = 'rejected';
            saveAppData();
            alert(`Deposit of $${formatMoney(d.amount)} rejected for User ID ${user.id}.`);
            updateAdminDepositsList();
            updateDepositsWithdrawalsUI();
          };

          actionsDiv.appendChild(approveBtn);
          actionsDiv.appendChild(rejectBtn);
          li.appendChild(actionsDiv);
          ul.appendChild(li);
        }
      });
    });
    if (!found) {
      ul.innerHTML = '<li>No pending deposit requests.</li>';
    }
  }

  function updateAdminWithdrawalsList() {
    const ul = document.getElementById('admin-withdrawals-list');
    ul.innerHTML = '';
    let found = false;
    Object.values(appData.users).forEach(user => {
      user.withdrawals.forEach(w => {
        if (w.status === 'pending') {
          found = true;
          const li = document.createElement('li');
          li.className = 'transaction-item';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.marginBottom = '12px';

          li.innerHTML = `
            <div>
              <strong>User ID: ${user.id}</strong><br />
              Amount: $${formatMoney(w.amount)}<br />
              Requested on: ${new Date(w.timestamp).toLocaleString()}
            </div>
          `;
          const actionsDiv = document.createElement('div');

          const approveBtn = document.createElement('button');
          approveBtn.className = 'small-button';
          approveBtn.textContent = 'Approve';
          approveBtn.style.background = '#2ABA6D';
          approveBtn.style.marginRight = '8px';
          approveBtn.onclick = () => {
            // Approve withdrawal: change status, confirm no funds returned (already deducted on request)
            w.status = 'approved';
            saveAppData();
            alert(`Withdrawal of $${formatMoney(w.amount)} approved for User ID ${user.id}.`);
            updateAdminWithdrawalsList();
            updateDepositsWithdrawalsUI();
            updateProfileUI(getCurrentUser());
          };

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'small-button';
          rejectBtn.textContent = 'Reject';
          rejectBtn.style.background = '#d9534f';
          rejectBtn.onclick = () => {
            // Reject withdrawal: refund funds to user balances (balance + bonus)
            // Refund funds in priority: balance, then bonus balance
            if (w.status !== 'pending') return;
            let refundAmount = w.amount;
            // Refund logic - add all to balance since the deduction was from balance + bonus
            user.balance += refundAmount;
            w.status = 'rejected';
            saveAppData();
            alert(`Withdrawal of $${formatMoney(w.amount)} rejected and amount refunded to User ID ${user.id}.`);
            updateAdminWithdrawalsList();
            updateDepositsWithdrawalsUI();
            updateProfileUI(getCurrentUser());
          };

          actionsDiv.appendChild(approveBtn);
          actionsDiv.appendChild(rejectBtn);
          li.appendChild(actionsDiv);
          ul.appendChild(li);
        }
      });
    });
    if (!found) {
      ul.innerHTML = '<li>No pending withdrawal requests.</li>';
    }
  }

  function setupAdminLogin() {
    const adminLoginBtn = document.getElementById('admin-login-button');
    const adminPasswordInput = document.getElementById('admin-password');
    const adminLoginMsg = document.getElementById('admin-login-msg');
    const adminLoginSection = document.getElementById('admin-login-section');
    const adminPanel = document.getElementById('admin-panel');

    adminLoginBtn.onclick = () => {
      if (adminPasswordInput.value === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        adminLoginMsg.textContent = '';
        adminLoginSection.style.display = 'none';
        adminPanel.style.display = 'block';
        updateAdminUsersList();
        updateAdminDepositsList();
        updateAdminWithdrawalsList();
      } else {
        adminLoginMsg.textContent = 'Incorrect password.';
        adminLoginMsg.className = 'error-msg';
        isAdminLoggedIn = false;
      }
    };
  }

  // Tab navigation
  function setupTabNavigation() {
    const buttons = document.querySelectorAll('nav button');
    buttons.forEach(btn => {
      btn.onclick = () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab + '-section').classList.add('active');
      };
    });
  }

  // Main init function after Telegram environment ready
  function main() {
    // Simulate Telegram login info - in real app use Telegram.WebApp.initDataUnsafe.user
    const telegramUser = telegramMockUser;

    // Initialize or load user
    const user = initUser(telegramUser);

    // Show profile info
    updateProfileUI(user);

    // Setup referral link and list
    updateReferralUI(user);
    setupReferralCopyButton();

    // Rewards button handlers
    setupRewardsHandlers();

    // Investment handlers and UI update
    setupInvestmentHandler();
    updateInvestmentUI();

    // Deposit and withdrawal handlers and UI update
    setupDepositWithdrawHandlers();
    updateDepositsWithdrawalsUI();

    // Admin login setup
    setupAdminLogin();

    // Tab navigation setup
    setupTabNavigation();
  }

  window.onload = main;
</script>
</body>
</html>

