<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Mini App - Investment & Reward System</title>
<style>
  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0a0f2d;
    color: #c3ccee;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #121843;
    padding: 1rem 1.5rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.5rem;
    letter-spacing: 0.05em;
    color: #bbe1fa;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }
  main {
    flex-grow: 1;
    padding: 1rem 1.5rem 6rem; /* bottom padding for footer */
    max-width: 480px;
    margin: 0 auto;
  }
  /* Footer icon menu */
  footer {
    background: #121843;
    height: 56px;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid #2b2e50;
  }
  footer button {
    background: none;
    border: none;
    outline: none;
    color: #7995c6;
    font-size: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.25s ease;
    padding: 2px 5px;
  }
  footer button.active, footer button:hover {
    color: #bbe1fa;
  }
  footer button span {
    font-size: 10px;
    margin-top: -3px;
    letter-spacing: 0.07em;
  }
  /* Sections */
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  /* User info card */
  #user-info {
    background: #1f286d;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.2rem;
    text-align: center;
    color: #d9e3f0;
    box-shadow: 0 2px 7px #0a0f2dcc;
  }
  #user-info img {
    border-radius: 50%;
    width: 72px;
    height: 72px;
    margin-bottom: 0.5rem;
    border: 2.5px solid #5fa1f1;
  }
  #user-info .user-name {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
  }
  #user-info .user-username {
    font-size: 0.9rem;
    color: #99a9d4;
  }
  /* Referral system */
  #referral-section {
    background: #1a2248;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
  }
  #referral-section h2 {
    margin-top: 0; margin-bottom: 0.5rem;
    color: #bbdefb;
    font-weight: 700;
  }
  #referral-link {
    background: #2e3a7c;
    border: none;
    border-radius: 5px;
    padding: 0.6rem 1rem;
    width: 100%;
    font-size: 0.9rem;
    color: #dde9ff;
    cursor: pointer;
  }
  #referral-copy-msg {
    margin-top: 0.4rem;
    font-size: 0.8rem;
    color: #88cc88;
    min-height: 18px;
  }
  /* Bonuses */
  #bonus-display {
    background: #22316a;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    text-align: center;
    color: #a3c0ff;
  }
  /* Ads section */
  #ads-section {
    background: #1f274a;
    border-radius: 8px;
    padding: 1rem 1.25rem;
  }
  #ads-section h2 {
    color: #bbdefb;
    margin-top: 0; 
  }
  #video-ad {
    width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 0.6rem;
    box-shadow: 0 0 15px #4464f2aa;
    background: black;
  }
  #watch-ad-btn, #click-ad-btn {
    background: #4464f2;
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    margin-bottom: 0.6rem;
    transition: background-color 0.3s ease;
  }
  #watch-ad-btn:disabled, #click-ad-btn:disabled {
    background: #667db6;
    cursor: not-allowed;
  }
  #ad-reward-msg {
    font-size: 0.9rem;
    color: #a3d977;
    height: 20px;
    text-align: center;
  }
  /* Investment section */
  #investment-section {
    background: #262a59;
    border-radius: 8px;
    padding: 1rem 1.25rem;
  }
  #investment-section h2 {
    color: #bbdefb;
    margin-top: 0;
  }
  #investment-form input[type=number] {
    width: 100%;
    padding: 0.6rem;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    margin-bottom: 0.8rem;
    outline: none;
  }
  #investment-form button {
    background: #7a95f9;
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.7rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }
  #investment-msg {
    margin-top: 0.6rem;
    color: #a3d977;
    font-weight: 600;
    min-height: 18px;
  }
  /* Wallet section */
  #wallet-section {
    background: #1d254b;
    border-radius: 8px;
    padding: 1rem 1.25rem;
  }
  #wallet-info {
    margin-bottom: 1rem;
    font-weight: 600;
  }
  /* Deposit / Withdraw */
  #deposit-withdraw-section {
    background: #22294f;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    max-height: 340px;
    overflow-y: auto;
  }
  #deposit-withdraw-section h2 {
    color: #bbdefb;
    margin-top: 0;
  }
  label {
    display: block;
    font-size: 0.85rem;
    margin-top: 0.6rem;
    margin-bottom: 0.2rem;
  }
  input[type=text], input[type=number] {
    width: 100%;
    padding: 0.5rem;
    border-radius: 5px;
    border: none;
    outline: none;
    font-size: 0.9rem;
  }
  button.submit-btn {
    margin-top: 0.8rem;
    background: #4477ff;
    border: none;
    padding: 0.6rem;
    color: white;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
  }
  button.submit-btn:disabled {
    background: #667db6;
    cursor: not-allowed;
  }
  #deposit-withdraw-msg {
    color: #a3d977;
    font-weight: 600;
    margin-top: 0.6rem;
    min-height: 18px;
  }
  /* Admin panel */
  #admin-panel {
    background: #19203a;
    border-radius: 8px;
    padding: 1rem 1.25rem;
  }
  #admin-panel h2 {
    color: #ffb347;
    margin-top: 0;
  }
  #admin-controls label {
    display: flex;
    align-items: center;
    margin-bottom: 0.7rem;
    cursor: pointer;
  }
  #admin-controls input[type=checkbox] {
    margin-right: 0.7rem;
    transform: scale(1.2);
  }
  #admin-message {
    color: #a3d977;
    min-height: 18px;
    margin-top: 0.6rem;
  }
  /* Scrollbar for deposit section (only in webkit) */
  #deposit-withdraw-section::-webkit-scrollbar {
    height: 6px;
  }
  #deposit-withdraw-section::-webkit-scrollbar-thumb {
    background-color: #5566aa;
    border-radius: 3px;
  }
  /* Responsive */
  @media (max-width: 500px) {
    main {
      padding: 1rem;
    }
    footer button {
      font-size: 20px;
    }
    #user-info img {
      width: 56px;
      height: 56px;
    }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<header>Telegram Mini App</header>
<main>
  <div id="user-info" aria-live="polite" aria-atomic="true" hidden>
    <img id="user-photo" alt="User profile photo" src="" />
    <div class="user-name" id="user-name"></div>
    <div class="user-username" id="user-username"></div>
  </div>

  <!-- Home Section -->
  <section id="home-section" class="active" aria-label="Home section">
    <div id="referral-section">
      <h2>Your Referral Link</h2>
      <input type="text" id="referral-link" readonly aria-describedby="referral-copy-msg" />
      <div id="referral-copy-msg" role="alert" aria-live="polite"></div>
    </div>
    <div id="bonus-display">
      Bonus Points: <span id="bonus-points">0</span><br />
      Referrals Count: <span id="referral-count">0</span>
    </div>
  </section>

  <!-- Wallet Section -->
  <section id="wallet-section" aria-label="Wallet section">
    <div id="wallet-info">
      Balance: <strong id="wallet-balance">0</strong> points
    </div>
  </section>

  <!-- Ads & Rewards Section -->
  <section id="ads-section" aria-label="Ads rewards section">
    <h2>Video Ads Rewards</h2>
    <iframe id="video-ad" src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=0&mute=1" title="Video ad" allowfullscreen sandbox="allow-scripts allow-same-origin"></iframe>
    <button id="watch-ad-btn" aria-live="polite">Watch Ad & Earn</button>
    <button id="click-ad-btn" aria-live="polite">Click Ad & Earn</button>
    <div id="ad-reward-msg" role="alert"></div>
  </section>

  <!-- Investment Section -->
  <section id="investment-section" aria-label="Investment section">
    <h2>Weekly Investment</h2>
    <form id="investment-form" aria-live="polite">
      <label for="invest-amount">Amount to invest (points):</label>
      <input type="number" id="invest-amount" min="1" max="10000" step="1" required aria-required="true" />
      <button type="submit">Invest Now</button>
      <div id="investment-msg" aria-live="polite"></div>
    </form>
    <div id="investment-status" style="margin-top: 1rem; font-weight: 600; color:#8ace8a;"></div>
  </section>

  <!-- Deposit and Withdraw Section -->
  <section id="deposit-withdraw-section" aria-label="Deposit and withdraw section">
    <h2>Deposit & Withdraw</h2>

    <form id="deposit-form">
      <h3>Deposit</h3>
      <label for="deposit-method">Deposit Method:</label>
      <select id="deposit-method" aria-required="true" name="deposit-method">
        <option value="paypal">PayPal</option>
        <option value="bkash">bKash</option>
      </select>
      <label for="deposit-amount">Amount (USD):</label>
      <input type="number" id="deposit-amount" min="1" max="10000" step="0.1" required aria-required="true" />
      <button type="submit" class="submit-btn">Deposit</button>
      <div id="deposit-msg" role="alert" aria-live="polite"></div>
    </form>

    <form id="withdraw-form" style="margin-top: 1rem;">
      <h3>Withdraw</h3>
      <label for="withdraw-method">Withdraw Method:</label>
      <select id="withdraw-method" aria-required="true" name="withdraw-method">
        <option value="paypal">PayPal</option>
        <option value="bkash">bKash</option>
      </select>
      <label for="withdraw-amount">Amount (USD):</label>
      <input type="number" id="withdraw-amount" min="1" max="10000" step="0.1" required aria-required="true" />
      <button type="submit" class="submit-btn">Withdraw</button>
      <div id="withdraw-msg" role="alert" aria-live="polite"></div>
    </form>
  </section>

  <!-- Admin Panel -->
  <section id="admin-panel" aria-label="Admin control panel" hidden>
    <h2>Admin Panel</h2>
    <div id="admin-controls">
      <label><input type="checkbox" id="toggle-deposits" /> Enable Deposits</label>
      <label><input type="checkbox" id="toggle-withdrawals" /> Enable Withdrawals</label>
      <label><input type="checkbox" id="toggle-video-ads" /> Enable Video Ads Rewards</label>
      <label><input type="checkbox" id="toggle-ppc-ads" /> Enable Pay-Per-Click Rewards</label>
    </div>
    <div id="admin-message" role="alert"></div>
  </section>
</main>

<footer role="navigation" aria-label="Main footer navigation">
  <button id="nav-home" aria-pressed="true" aria-label="Go to Home section" class="active"><i class="fas fa-home"></i><span>Home</span></button>
  <button id="nav-wallet" aria-pressed="false" aria-label="Go to Wallet section"><i class="fas fa-wallet"></i><span>Wallet</span></button>
  <button id="nav-ads" aria-pressed="false" aria-label="Go to Ads section"><i class="fas fa-video"></i><span>Ads</span></button>
  <button id="nav-invest" aria-pressed="false" aria-label="Go to Investment section"><i class="fas fa-chart-line"></i><span>Invest</span></button>
  <button id="nav-depwith" aria-pressed="false" aria-label="Go to Deposit and Withdraw section"><i class="fas fa-money-bill-wave"></i><span>Wallet</span></button>
  <button id="nav-admin" aria-pressed="false" aria-label="Go to Admin panel (Admin only)"><i class="fas fa-cogs"></i><span>Admin</span></button>
</footer>

<script>
  // Telegram Web App initialization stub
  // In an actual Telegram Mini App, Telegram Web App init would provide user info.
  // Here we simulate Telegram login by prompting or using defaults.
  const Telegram = window.Telegram || {
    WebApp: {
      initDataUnsafe: {},
      onEvent: () => {},
      ready: () => {},
      readyPromise: Promise.resolve(),
      HapticFeedback: { vibrate: () => {} },
      getUser: () => {
        // Simulated user info
        return {
          id: 123456789,
          first_name: "John",
          last_name: "Doe",
          username: "john_doe",
          photo_url: "https://cdn-icons-png.flaticon.com/512/147/147144.png",
          language_code: "en"
        }
      }
    }
  };

  // Simulated user session and data storage keys
  const STORAGE_KEYS = {
    USER: 'tmini_user',
    BONUS_POINTS: 'tmini_bonus_points',
    REFERRALS: 'tmini_referrals',
    BALANCE: 'tmini_balance',
    INVESTMENT: 'tmini_investment',
    ADMIN_ENABLED: 'tmini_admin_enabled',
    ADMIN_SETTINGS: 'tmini_admin_settings'
  };

  // App State
  let appState = {
    user: null,
    bonusPoints: 0,
    referralsCount: 0,
    balance: 0,
    investment: 0,
    investmentsThisWeek: 0,
    adminEnabled: false,
    adminSettings: {
      depositsEnabled: true,
      withdrawalsEnabled: true,
      videoAdsEnabled: true,
      ppcAdsEnabled: true,
    }
  };

  // Utility: save to localStorage
  function saveAppState() {
    localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(appState.user));
    localStorage.setItem(STORAGE_KEYS.BONUS_POINTS, appState.bonusPoints);
    localStorage.setItem(STORAGE_KEYS.REFERRALS, appState.referralsCount);
    localStorage.setItem(STORAGE_KEYS.BALANCE, appState.balance);
    localStorage.setItem(STORAGE_KEYS.INVESTMENT, appState.investment);
    localStorage.setItem(STORAGE_KEYS.ADMIN_ENABLED, appState.adminEnabled ? '1' : '0');
    localStorage.setItem(STORAGE_KEYS.ADMIN_SETTINGS, JSON.stringify(appState.adminSettings));
  }

  // Utility: load from localStorage
  function loadAppState() {
    const userData = localStorage.getItem(STORAGE_KEYS.USER);
    appState.user = userData ? JSON.parse(userData) : null;
    appState.bonusPoints = parseInt(localStorage.getItem(STORAGE_KEYS.BONUS_POINTS)) || 0;
    appState.referralsCount = parseInt(localStorage.getItem(STORAGE_KEYS.REFERRALS)) || 0;
    appState.balance = parseInt(localStorage.getItem(STORAGE_KEYS.BALANCE)) || 0;
    appState.investment = parseInt(localStorage.getItem(STORAGE_KEYS.INVESTMENT)) || 0;
    appState.adminEnabled = localStorage.getItem(STORAGE_KEYS.ADMIN_ENABLED) === '1';
    const adminSettingsRaw = localStorage.getItem(STORAGE_KEYS.ADMIN_SETTINGS);
    if (adminSettingsRaw) {
      try {
        appState.adminSettings = JSON.parse(adminSettingsRaw);
      } catch(e) {}
    }
  }

  // Generate referral link
  function generateReferralLink(userId) {
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}?ref=${userId}`;
  }

  // Copy referral link to clipboard
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      showReferralCopyMsg('Copied to clipboard!');
    }).catch(() => {
      showReferralCopyMsg('Copy failed. Please copy manually.');
    });
  }

  function showReferralCopyMsg(msg) {
    const msgElem = document.getElementById('referral-copy-msg');
    msgElem.textContent = msg;
    setTimeout(() => { msgElem.textContent = ''; }, 3000);
  }

  // Accept referral if "ref" param exists in URL and not self
  function handleReferral(userId) {
    const urlParams = new URLSearchParams(window.location.search);
    const refId = urlParams.get('ref');
    // If referral id exists, and different from current user
    if (refId && refId !== userId.toString()) {
      let referrals = JSON.parse(localStorage.getItem('tmini_all_referrals') || '{}');
      if (!referrals[userId]) {
        // Mark user was referred by refId
        referrals[userId] = refId;
        localStorage.setItem('tmini_all_referrals', JSON.stringify(referrals));
        // Increase referrer bonus points on their account (simulate)
        // In real app backed by server, this would update referrer account.
        // For demo, increase global referral count and bonus for current user (mock)
        // Here we just simulate ref bonus to current user
        appState.bonusPoints += 50;
        appState.referralsCount += 1;
        appState.balance += 10;
        saveAppState();
      }
    }
  }

  // Update UI user info
  function updateUserInfo() {
    if (!appState.user) return;
    const userSection = document.getElementById('user-info');
    const userImage = document.getElementById('user-photo');
    const userName = document.getElementById('user-name');
    const userUsername = document.getElementById('user-username');
    userImage.src = appState.user.photo_url || 'https://cdn-icons-png.flaticon.com/512/147/147144.png';
    userImage.alt = `Profile photo of ${appState.user.first_name}`;
    userName.textContent = appState.user.first_name + (appState.user.last_name ? ' ' + appState.user.last_name : '');
    userUsername.textContent = appState.user.username ? '@' + appState.user.username : '';
    userSection.hidden = false;
  }

  // Update referral UI
  function updateReferralUI() {
    const referralLinkElem = document.getElementById('referral-link');
    referralLinkElem.value = generateReferralLink(appState.user.id);
    document.getElementById('bonus-points').textContent = appState.bonusPoints;
    document.getElementById('referral-count').textContent = appState.referralsCount;
  }

  // Update wallet UI
  function updateWalletUI() {
    document.getElementById('wallet-balance').textContent = appState.balance;
  }

  // Show section by id
  function showSection(sectionId) {
    const sections = document.querySelectorAll('main > section');
    sections.forEach(s => {
      s.classList.toggle('active', s.id === sectionId);
    });
    // Update footer buttons active state and aria-pressed
    const footerButtons = document.querySelectorAll('footer button');
    footerButtons.forEach(btn => {
      const targetId = btn.id.replace('nav-', '') + '-section';
      const isActive = (targetId === sectionId) || (btn.id === 'nav-depwith' && sectionId === 'deposit-withdraw-section');
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  // Initialize footer nav events
  function initFooterNavigation() {
    document.getElementById('nav-home').addEventListener('click', () => showSection('home-section'));
    document.getElementById('nav-wallet').addEventListener('click', () => showSection('wallet-section'));
    document.getElementById('nav-ads').addEventListener('click', () => showSection('ads-section'));
    document.getElementById('nav-invest').addEventListener('click', () => showSection('investment-section'));
    document.getElementById('nav-depwith').addEventListener('click', () => showSection('deposit-withdraw-section'));
    document.getElementById('nav-admin').addEventListener('click', () => {
      if (appState.adminEnabled) {
        showSection('admin-panel');
      } else {
        alert('Admin panel access denied.');
      }
    });
  }

  // Watch Ad Button behavior
  function initAdsButtons() {
    const watchAdBtn = document.getElementById('watch-ad-btn');
    const clickAdBtn = document.getElementById('click-ad-btn');
    const rewardMsg = document.getElementById('ad-reward-msg');

    // Enable/disable buttons depending on admin settings
    function updateAdsButtonsState() {
      watchAdBtn.disabled = !appState.adminSettings.videoAdsEnabled;
      clickAdBtn.disabled = !appState.adminSettings.ppcAdsEnabled;
    }

    watchAdBtn.addEventListener('click', () => {
      watchAdBtn.disabled = true;
      rewardMsg.textContent = 'Playing ad... please wait.';
      // Simulate ad watched for 5 seconds
      setTimeout(() => {
        rewardMsg.textContent = 'You earned 20 points for watching the ad!';
        appState.bonusPoints += 20;
        appState.balance += 20;
        saveAppState();
        updateBonusAndWallet();
        watchAdBtn.disabled = false;
      }, 5000);
    });

    clickAdBtn.addEventListener('click', () => {
      appState.bonusPoints += 5;
      appState.balance += 5;
      saveAppState();
      updateBonusAndWallet();
      rewardMsg.textContent = 'You earned 5 points for clicking the ad!';
      setTimeout(() => { rewardMsg.textContent = ''; }, 3000);
    });
    updateAdsButtonsState();
  }

  // Update bonuses and wallet UI
  function updateBonusAndWallet() {
    document.getElementById('bonus-points').textContent = appState.bonusPoints;
    document.getElementById('wallet-balance').textContent = appState.balance;
  }

  // Investment form handling
  function initInvestmentSection() {
    const investForm = document.getElementById('investment-form');
    const investMsg = document.getElementById('investment-msg');
    const investStatus = document.getElementById('investment-status');

    // Track investments weekly
    appState.investmentsThisWeek = appState.investmentsThisWeek || 0;

    // Show current investment status
    investStatus.textContent = `You have invested ${appState.investment} points this week.`;

    investForm.addEventListener('submit', e => {
      e.preventDefault();
      const amount = parseInt(document.getElementById('invest-amount').value);
      if (amount < 1) {
        investMsg.textContent = 'Investment must be at least 1 point.';
        return;
      }
      // Simulate weekly investment limit of 10000 points
      if (appState.investmentsThisWeek + amount > 10000) {
        investMsg.textContent = 'Weekly investment limit (10,000 points) exceeded.';
        return;
      }
      if (amount > appState.balance) {
        investMsg.textContent = 'Insufficient balance to invest.';
        return;
      }
      appState.investment += amount;
      appState.balance -= amount;
      appState.investmentsThisWeek += amount;
      investMsg.textContent = `Invested ${amount} points successfully!`;
      investStatus.textContent = `You have invested ${appState.investment} points this week.`;
      saveAppState();
      updateWalletUI();
      updateBonusAndWallet();
      investForm.reset();
    });
  }

  // Deposit and Withdraw forms handling (mock offline functionality)
  function initDepositWithdraw() {
    const depositForm = document.getElementById('deposit-form');
    const withdrawForm = document.getElementById('withdraw-form');
    const depositMsg = document.getElementById('deposit-msg');
    const withdrawMsg = document.getElementById('withdraw-msg');

    function clearMessages() {
      depositMsg.textContent = '';
      withdrawMsg.textContent = '';
    }
    depositForm.addEventListener('submit', e => {
      e.preventDefault();
      clearMessages();
      if (!appState.adminSettings.depositsEnabled) {
        depositMsg.textContent = 'Deposits are currently disabled by admin.';
        return;
      }
      const method = depositForm['deposit-method'].value;
      const amount = parseFloat(depositForm['deposit-amount'].value);
      if (amount < 1) {
        depositMsg.textContent = 'Amount must be at least 1 USD.';
        return;
      }
      // Offline deposit simulation: add to balance after confirmation
      depositMsg.textContent = `Deposit of $${amount.toFixed(2)} via ${method} is being processed offline. Your balance will update after admin confirms.`;
      depositForm.reset();
    });
    withdrawForm.addEventListener('submit', e => {
      e.preventDefault();
      clearMessages();
      if (!appState.adminSettings.withdrawalsEnabled) {
        withdrawMsg.textContent = 'Withdrawals are currently disabled by admin.';
        return;
      }
      const method = withdrawForm['withdraw-method'].value;
      const amount = parseFloat(withdrawForm['withdraw-amount'].value);
      if (amount < 1) {
        withdrawMsg.textContent = 'Amount must be at least 1 USD.';
        return;
      }
      if (amount > appState.balance) {
        withdrawMsg.textContent = 'Insufficient balance for withdrawal.';
        return;
      }
      // Offline withdraw simulation: deduct from balance after confirmation
      appState.balance -= Math.floor(amount);
      saveAppState();
      updateWalletUI();
      withdrawMsg.textContent = `Withdrawal of $${amount.toFixed(2)} via ${method} has been submitted for offline processing. Balance updated.`;
      withdrawForm.reset();
    });
  }

  // Admin panel handling
  function initAdminPanel() {
    const adminPanel = document.getElementById('admin-panel');
    const toggleDeposits = document.getElementById('toggle-deposits');
    const toggleWithdrawals = document.getElementById('toggle-withdrawals');
    const toggleVideoAds = document.getElementById('toggle-video-ads');
    const togglePPCAds = document.getElementById('toggle-ppc-ads');
    const adminMsg = document.getElementById('admin-message');

    // Initialize controls from adminSettings
    toggleDeposits.checked = appState.adminSettings.depositsEnabled;
    toggleWithdrawals.checked = appState.adminSettings.withdrawalsEnabled;
    toggleVideoAds.checked = appState.adminSettings.videoAdsEnabled;
    togglePPCAds.checked = appState.adminSettings.ppcAdsEnabled;

    function saveAdminSettings() {
      appState.adminSettings.depositsEnabled = toggleDeposits.checked;
      appState.adminSettings.withdrawalsEnabled = toggleWithdrawals.checked;
      appState.adminSettings.videoAdsEnabled = toggleVideoAds.checked;
      appState.adminSettings.ppcAdsEnabled = togglePPCAds.checked;
      saveAppState();
      adminMsg.textContent = 'Admin settings saved.';
      initAdsButtons(); // update ads button state
      setTimeout(() => { adminMsg.textContent = ''; }, 3000);
    }

    toggleDeposits.addEventListener('change', saveAdminSettings);
    toggleWithdrawals.addEventListener('change', saveAdminSettings);
    toggleVideoAds.addEventListener('change', saveAdminSettings);
    togglePPCAds.addEventListener('change', saveAdminSettings);
  }

  // Initialize admin access (for demo: allow admin if username is 'admin')
  function checkAdminAccess() {
    if (appState.user && appState.user.username === 'admin') {
      appState.adminEnabled = true;
      saveAppState();
      document.getElementById('nav-admin').style.display = 'inline-flex';
    } else {
      appState.adminEnabled = false;
      saveAppState();
      document.getElementById('nav-admin').style.display = 'none';
    }
  }

  // Initialize the whole app
  function initApp() {
    loadAppState();

    // Telegram auto login simulation
    let user = Telegram.WebApp.getUser();
    if (!user) {
      // For demo: prompt user for username and name
      const uname = prompt('Enter Telegram username (or leave to continue as Guest):', 'guest');
      user = {
        id: Math.floor(Math.random() * 1000000000),
        first_name: uname || 'Guest',
        last_name: '',
        username: uname || '',
        photo_url: 'https://cdn-icons-png.flaticon.com/512/147/147144.png',
        language_code: 'en'
      };
    }
    appState.user = user;

    // Save user to state and local for autologin
    saveAppState();

    updateUserInfo();
    updateReferralUI();
    updateWalletUI();

    // Handle referral based on URL param
    handleReferral(user.id);

    // Setup navigation controls
    initFooterNavigation();

    // Setup ads buttons
    initAdsButtons();

    // Init investment form
    initInvestmentSection();

    // Init deposit & withdraw forms
    initDepositWithdraw();

    // Init admin panel controls
    initAdminPanel();

    // Admin access check
    checkAdminAccess();

    // Default to home section on startup
    showSection('home-section');

    // Referral link click copy behavior
    const refLink = document.getElementById('referral-link');
    refLink.addEventListener('click', () => {
      copyToClipboard(refLink.value);
    });
  }

  initApp();
</script>
</body>
</html>

