<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Telegram Mini App</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
  
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #f0f0f0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .admin-container {
    background: #1f1f3a;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    overflow: hidden;
    width: 100%;
    max-width: 1200px;
    min-height: 600px;
  }
  
  .admin-header {
    background: #2c2c55;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.8);
  }
  
  .admin-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1.2px;
  }
  
  .admin-content {
    padding: 30px;
  }
  
  .login-section {
    max-width: 400px;
    margin: 0 auto;
    text-align: center;
  }
  
  .login-form {
    background: #2c2c55;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(94,82,243,0.6);
  }
  
  .form-group {
    margin-bottom: 20px;
    text-align: left;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #e0e0e0;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px 16px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.1);
    color: #eee;
    transition: background-color 0.3s;
  }
  
  .form-group input:focus {
    background: rgba(255,255,255,0.2);
  }
  
  .btn-login {
    width: 100%;
    padding: 14px;
    background: #8a64f5;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-login:hover {
    background: #6f45e7;
  }
  
  .btn-login:disabled {
    background: #54438e;
    cursor: not-allowed;
  }
  
  .dashboard-section {
    display: none;
  }
  
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .dashboard-card {
    background: #2c2c55;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(94,82,243,0.6);
  }
  
  .dashboard-card h3 {
    margin: 0 0 15px 0;
    color: #b8a1ff;
    font-size: 1.2rem;
    border-bottom: 2px solid #5e52f3;
    padding-bottom: 8px;
  }
  
  .stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .stat-value {
    font-weight: 600;
    color: #8a64f5;
  }
  
  .user-list {
    max-height: 300px;
    overflow-y: auto;
  }
  
  .user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
  }
  
  .user-info {
    flex-grow: 1;
  }
  
  .user-name {
    font-weight: 600;
    margin-bottom: 4px;
  }
  
  .user-details {
    font-size: 0.85rem;
    opacity: 0.8;
  }
  
  .user-actions {
    display: flex;
    gap: 8px;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 0.8rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-approve {
    background: #28a745;
    color: white;
  }
  
  .btn-reject {
    background: #dc3545;
    color: white;
  }
  
  .btn-view {
    background: #17a2b8;
    color: white;
  }
  
  .btn-small:hover {
    opacity: 0.8;
  }
  
  .controls-section {
    background: #421f59;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .control-item {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .control-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .control-item label {
    font-weight: 600;
    cursor: pointer;
  }
  
  .logout-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .logout-btn:hover {
    background: #c82333;
  }
  
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4444cc;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(100,80,255,0.9);
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }
  
  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }
  
  .back-to-app {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background: #5e52f3;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  
  .back-to-app:hover {
    background: #483acb;
  }
</style>
</head>
<body>
<div class="admin-container">
  <div class="admin-header">
    <h1>Admin Panel</h1>
    <button id="logout-btn" class="logout-btn" style="display: none;">Logout</button>
  </div>
  
  <div class="admin-content">
    <!-- Login Section -->
    <div id="login-section" class="login-section">
      <div class="login-form">
        <h2>Admin Login</h2>
        <form id="admin-login-form">
          <div class="form-group">
            <label for="admin-username">Username:</label>
            <input type="text" id="admin-username" required>
          </div>
          <div class="form-group">
            <label for="admin-password">Password:</label>
            <input type="password" id="admin-password" required>
          </div>
          <button type="submit" class="btn-login">Login</button>
        </form>
        <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
          Demo credentials: admin / admin123
        </p>
        <a href="code.html" class="back-to-app">← Back to Main App</a>
      </div>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard-section">
      <!-- System Controls -->
      <div class="controls-section">
        <h3>System Controls</h3>
        <div class="controls-grid">
          <div class="control-item">
            <input type="checkbox" id="toggle-deposits" checked>
            <label for="toggle-deposits">Enable Deposits</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-withdrawals" checked>
            <label for="toggle-withdrawals">Enable Withdrawals</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-registrations" checked>
            <label for="toggle-registrations">Enable New Registrations</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-rewards" checked>
            <label for="toggle-rewards">Enable Reward Claims</label>
          </div>
        </div>
      </div>
      
      <!-- Dashboard Cards -->
      <div class="dashboard-grid">
        <!-- Statistics Card -->
        <div class="dashboard-card">
          <h3>System Statistics</h3>
          <div class="stat-item">
            <span>Total Users:</span>
            <span class="stat-value" id="total-users">0</span>
          </div>
          <div class="stat-item">
            <span>Active Users (24h):</span>
            <span class="stat-value" id="active-users">0</span>
          </div>
          <div class="stat-item">
            <span>Total Deposits:</span>
            <span class="stat-value" id="total-deposits">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Total Withdrawals:</span>
            <span class="stat-value" id="total-withdrawals">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Pending Requests:</span>
            <span class="stat-value" id="pending-requests">0</span>
          </div>
        </div>
        
        <!-- Recent Users -->
        <div class="dashboard-card">
          <h3>Recent Users</h3>
          <div class="user-list" id="recent-users">
            <!-- Users will be populated here -->
          </div>
        </div>
        
        <!-- Pending Deposits -->
        <div class="dashboard-card">
          <h3>Pending Deposits</h3>
          <div class="user-list" id="pending-deposits">
            <!-- Pending deposits will be populated here -->
          </div>
        </div>
        
        <!-- Pending Withdrawals -->
        <div class="dashboard-card">
          <h3>Pending Withdrawals</h3>
          <div class="user-list" id="pending-withdrawals">
            <!-- Pending withdrawals will be populated here -->
          </div>
        </div>
        
        <!-- Investment Tracking -->
        <div class="dashboard-card">
          <h3>Investment Tracking</h3>
          <div class="user-list" id="investment-tracking">
            <!-- Investment data will be populated here -->
          </div>
        </div>
        
        <!-- Investment Statistics -->
        <div class="dashboard-card">
          <h3>Investment Statistics</h3>
          <div class="stat-item">
            <span>Total Investments:</span>
            <span class="stat-value" id="total-investments">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Active Investors:</span>
            <span class="stat-value" id="active-investors">0</span>
          </div>
          <div class="stat-item">
            <span>Weekly Returns Paid:</span>
            <span class="stat-value" id="weekly-returns">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Average Investment:</span>
            <span class="stat-value" id="avg-investment">0 BDT</span>
          </div>
        </div>
        
        <!-- Video Ad Management -->
        <div class="dashboard-card">
          <h3>Video Ad Management</h3>
          <div class="form-group">
            <label for="video-1-url">Video Ad #1 URL:</label>
            <input type="text" id="video-1-url" placeholder="YouTube embed URL">
            <button class="btn-small btn-approve" onclick="updateVideoUrl(1)">Update</button>
          </div>
          <div class="form-group">
            <label for="video-2-url">Video Ad #2 URL:</label>
            <input type="text" id="video-2-url" placeholder="YouTube embed URL">
            <button class="btn-small btn-approve" onclick="updateVideoUrl(2)">Update</button>
          </div>
          <div class="form-group">
            <label for="video-3-url">Video Ad #3 URL:</label>
            <input type="text" id="video-3-url" placeholder="YouTube embed URL">
            <button class="btn-small btn-approve" onclick="updateVideoUrl(3)">Update</button>
          </div>
          <div class="form-group">
            <label for="video-4-url">Video Ad #4 URL:</label>
            <input type="text" id="video-4-url" placeholder="YouTube embed URL">
            <button class="btn-small btn-approve" onclick="updateVideoUrl(4)">Update</button>
          </div>
          <div class="form-group">
            <label for="video-5-url">Video Ad #5 URL:</label>
            <input type="text" id="video-5-url" placeholder="YouTube embed URL">
            <button class="btn-small btn-approve" onclick="updateVideoUrl(5)">Update</button>
          </div>
        </div>
      </div>
      
      <a href="code.html" class="back-to-app">← Back to Main App</a>
    </div>
  </div>
</div>

<div id="toast" class="toast">Message</div>

<script>
(() => {
  // Admin credentials (in production, this should be server-side)
  const ADMIN_CREDENTIALS = {
    username: 'admin',
    password: 'admin123'
  };
  
  // Storage keys
  const ADMIN_SESSION_KEY = 'adminSession';
  const USER_DATA_KEY = 'telegramMiniAppUser';
  const ADMIN_SETTINGS_KEY = 'adminSettings';
  
  // Elements
  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('admin-login-form');
  const logoutBtn = document.getElementById('logout-btn');
  const toastEl = document.getElementById('toast');
  
  // Control elements
  const toggleDeposits = document.getElementById('toggle-deposits');
  const toggleWithdrawals = document.getElementById('toggle-withdrawals');
  const toggleRegistrations = document.getElementById('toggle-registrations');
  const toggleRewards = document.getElementById('toggle-rewards');
  
  // Statistics elements
  const totalUsersEl = document.getElementById('total-users');
  const activeUsersEl = document.getElementById('active-users');
  const totalDepositsEl = document.getElementById('total-deposits');
  const totalWithdrawalsEl = document.getElementById('total-withdrawals');
  const pendingRequestsEl = document.getElementById('pending-requests');
  
  // List elements
  const recentUsersEl = document.getElementById('recent-users');
  const pendingDepositsEl = document.getElementById('pending-deposits');
  const pendingWithdrawalsEl = document.getElementById('pending-withdrawals');
  const investmentTrackingEl = document.getElementById('investment-tracking');
  
  // Investment statistics elements
  const totalInvestmentsEl = document.getElementById('total-investments');
  const activeInvestorsEl = document.getElementById('active-investors');
  const weeklyReturnsEl = document.getElementById('weekly-returns');
  const avgInvestmentEl = document.getElementById('avg-investment');
  
  // Load real data from localStorage
  function loadUsers() {
    const users = localStorage.getItem('registeredUsers') || '[]';
    try {
      return JSON.parse(users);
    } catch {
      return [];
    }
  }

  function loadTransactions() {
    const deposits = localStorage.getItem('deposits') || '[]';
    const withdrawals = localStorage.getItem('withdrawals') || '[]';
    try {
      return {
        deposits: JSON.parse(deposits),
        withdrawals: JSON.parse(withdrawals)
      };
    } catch {
      return { deposits: [], withdrawals: [] };
    }
  }

  function getActiveUsers() {
    const users = loadUsers();
    const now = Date.now();
    const oneDayAgo = now - (24 * 60 * 60 * 1000);
    return users.filter(user => {
      const lastActive = user.lastActive ? new Date(user.lastActive).getTime() : 0;
      return lastActive > oneDayAgo;
    });
  }

  function getTotalDeposits() {
    const { deposits } = loadTransactions();
    return deposits.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
  }

  function getTotalWithdrawals() {
    const { withdrawals } = loadTransactions();
    return withdrawals.reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);
  }

  function getPendingTransactions() {
    const { deposits, withdrawals } = loadTransactions();
    return {
      deposits: deposits.filter(d => d.status === 'pending'),
      withdrawals: withdrawals.filter(w => w.status === 'pending')
    };
  }

  // Initialize data
  let users = loadUsers();
  const transactions = loadTransactions();
  let pendingDeposits = transactions.deposits.filter(d => d.status === 'pending');
  let pendingWithdrawals = transactions.withdrawals.filter(w => w.status === 'pending');
  
  // Load real investment data from localStorage
  function loadInvestments() {
    const investments = localStorage.getItem('userInvestments');
    if (investments) {
      try {
        return JSON.parse(investments).map(inv => ({
          ...inv,
          startDate: new Date(inv.startDate) // Convert string back to Date
        }));
      } catch {
        return [];
      }
    }
    return [];
  }
  
  // Save investments back to localStorage
  function saveInvestments(investments) {
    localStorage.setItem('userInvestments', JSON.stringify(investments));
  }
  
  let mockInvestments = loadInvestments();
  
  // Utility functions
  function showToast(message, duration = 3000) {
    toastEl.textContent = message;
    toastEl.classList.add('show');
    setTimeout(() => {
      toastEl.classList.remove('show');
    }, duration);
  }
  
  function isAdminLoggedIn() {
    const session = localStorage.getItem(ADMIN_SESSION_KEY);
    if (!session) return false;
    
    try {
      const sessionData = JSON.parse(session);
      // Check if session is still valid (24 hours)
      const now = Date.now();
      const sessionAge = now - sessionData.timestamp;
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      return sessionAge < maxAge;
    } catch {
      return false;
    }
  }
  
  function setAdminSession() {
    const sessionData = {
      timestamp: Date.now(),
      username: ADMIN_CREDENTIALS.username
    };
    localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(sessionData));
  }
  
  function clearAdminSession() {
    localStorage.removeItem(ADMIN_SESSION_KEY);
  }
  
  function loadAdminSettings() {
    const settings = localStorage.getItem(ADMIN_SETTINGS_KEY);
    if (settings) {
      try {
        return JSON.parse(settings);
      } catch {
        return getDefaultSettings();
      }
    }
    return getDefaultSettings();
  }
  
  function saveAdminSettings(settings) {
    localStorage.setItem(ADMIN_SETTINGS_KEY, JSON.stringify(settings));
    // Also update the main app's settings
    const userData = localStorage.getItem(USER_DATA_KEY);
    if (userData) {
      try {
        const data = JSON.parse(userData);
        data.depositEnabled = settings.depositsEnabled;
        data.withdrawEnabled = settings.withdrawalsEnabled;
        localStorage.setItem(USER_DATA_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Error updating main app settings:', e);
      }
    }
  }
  
  function getDefaultSettings() {
    return {
      depositsEnabled: true,
      withdrawalsEnabled: true,
      registrationsEnabled: true,
      rewardsEnabled: true
    };
  }
  
  function formatDate(date) {
    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  }
  
  function renderDashboard() {
    // Update statistics
    totalUsersEl.textContent = users.length;
    activeUsersEl.textContent = getActiveUsers().length;
    totalDepositsEl.textContent = getTotalDeposits().toFixed(2) + ' BDT';
    totalWithdrawalsEl.textContent = getTotalWithdrawals().toFixed(2) + ' BDT';
    pendingRequestsEl.textContent = pendingDeposits.length + pendingWithdrawals.length;
    
    // Update investment statistics
    const totalInvestmentAmount = mockInvestments.reduce((sum, inv) => sum + inv.amount, 0);
    const activeInvestments = mockInvestments.filter(inv => inv.status === 'active');
    const totalWeeklyReturns = mockInvestments.reduce((sum, inv) => sum + inv.totalReturns, 0);
    const avgInvestment = mockInvestments.length > 0 ? totalInvestmentAmount / mockInvestments.length : 0;
    
    totalInvestmentsEl.textContent = totalInvestmentAmount.toFixed(2) + ' BDT';
    activeInvestorsEl.textContent = activeInvestments.length;
    weeklyReturnsEl.textContent = totalWeeklyReturns.toFixed(2) + ' BDT';
    avgInvestmentEl.textContent = avgInvestment.toFixed(2) + ' BDT';
    
    // Render recent users
    recentUsersEl.innerHTML = users.slice(0, 5).map(user => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${user.first_name} ${user.last_name || ''}</div>
          <div class="user-details">ID: ${user.id}</div>
          <div class="user-details">Last Active: ${formatDate(new Date(user.lastActive || Date.now()))}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-view" onclick="viewUser(${user.id})">View</button>
        </div>
      </div>
    `).join('');
    
    // Render pending deposits
    pendingDepositsEl.innerHTML = pendingDeposits.map(deposit => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${deposit.userName}</div>
          <div class="user-details">${deposit.amount} BDT via ${deposit.method}</div>
          <div class="user-details">Ref: ${deposit.reference}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-approve" onclick="approveDeposit(${deposit.id})">Approve</button>
          <button class="btn-small btn-reject" onclick="rejectDeposit(${deposit.id})">Reject</button>
        </div>
      </div>
    `).join('');
    
    // Render pending withdrawals
    pendingWithdrawalsEl.innerHTML = pendingWithdrawals.map(withdrawal => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${withdrawal.userName}</div>
          <div class="user-details">${withdrawal.amount} BDT via ${withdrawal.method}</div>
          <div class="user-details">To: ${withdrawal.address}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-approve" onclick="approveWithdrawal(${withdrawal.id})">Approve</button>
          <button class="btn-small btn-reject" onclick="rejectWithdrawal(${withdrawal.id})">Reject</button>
        </div>
      </div>
    `).join('');
    
    // Render investment tracking
    investmentTrackingEl.innerHTML = mockInvestments.map(investment => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${investment.userName}</div>
          <div class="user-details">Investment: ${investment.amount} BDT | Weekly Return: ${investment.weeklyReturn} BDT</div>
          <div class="user-details">Started: ${formatDate(investment.startDate)} | Status: ${investment.status}</div>
          <div class="user-details">Total Returns: ${investment.totalReturns} BDT | Weeks Remaining: ${investment.weeksRemaining}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-view" onclick="viewInvestment(${investment.id})">View</button>
          ${investment.status === 'active' ? `<button class="btn-small btn-approve" onclick="payWeeklyReturn(${investment.id})">Pay Return</button>` : ''}
          ${investment.status === 'active' ? `<button class="btn-small btn-reject" onclick="closeInvestment(${investment.id})">Close</button>` : ''}
        </div>
      </div>
    `).join('');
  }
  
  function showDashboard() {
    loginSection.style.display = 'none';
    dashboardSection.style.display = 'block';
    logoutBtn.style.display = 'block';
    
    // Load and apply admin settings
    const settings = loadAdminSettings();
    toggleDeposits.checked = settings.depositsEnabled;
    toggleWithdrawals.checked = settings.withdrawalsEnabled;
    toggleRegistrations.checked = settings.registrationsEnabled;
    toggleRewards.checked = settings.rewardsEnabled;
    
    renderDashboard();
  }
  
  function showLogin() {
    loginSection.style.display = 'block';
    dashboardSection.style.display = 'none';
    logoutBtn.style.display = 'none';
  }
  
  // Global functions for button actions
  window.viewUser = function(userId) {
    const user = users.find(u => u.id === userId);
    if (user) {
      showToast(`Viewing user: ${user.first_name} ${user.last_name || ''} (ID: ${user.id})`);
    }
  };
  
  window.approveDeposit = function(depositId) {
    const { deposits } = loadTransactions();
    const updatedDeposits = deposits.map(d => {
      if (d.id === depositId) {
        return { ...d, status: 'approved' };
      }
      return d;
    });
    
    localStorage.setItem('deposits', JSON.stringify(updatedDeposits));
    pendingDeposits = updatedDeposits.filter(d => d.status === 'pending');
    
    showToast(`Deposit approved`);
    renderDashboard();
  };
  
  window.rejectDeposit = function(depositId) {
    const { deposits } = loadTransactions();
    const updatedDeposits = deposits.map(d => {
      if (d.id === depositId) {
        return { ...d, status: 'rejected' };
      }
      return d;
    });
    
    localStorage.setItem('deposits', JSON.stringify(updatedDeposits));
    pendingDeposits = updatedDeposits.filter(d => d.status === 'pending');
    
    showToast(`Deposit rejected`);
    renderDashboard();
  };
  
  window.approveWithdrawal = function(withdrawalId) {
    const { withdrawals } = loadTransactions();
    const updatedWithdrawals = withdrawals.map(w => {
      if (w.id === withdrawalId) {
        return { ...w, status: 'approved' };
      }
      return w;
    });
    
    localStorage.setItem('withdrawals', JSON.stringify(updatedWithdrawals));
    pendingWithdrawals = updatedWithdrawals.filter(w => w.status === 'pending');
    
    showToast(`Withdrawal approved`);
    renderDashboard();
  };
  
  window.rejectWithdrawal = function(withdrawalId) {
    const { withdrawals } = loadTransactions();
    const updatedWithdrawals = withdrawals.map(w => {
      if (w.id === withdrawalId) {
        return { ...w, status: 'rejected' };
      }
      return w;
    });
    
    localStorage.setItem('withdrawals', JSON.stringify(updatedWithdrawals));
    pendingWithdrawals = updatedWithdrawals.filter(w => w.status === 'pending');
    
    showToast(`Withdrawal rejected`);
    renderDashboard();
  };
  
  // Investment management functions
  window.viewInvestment = function(investmentId) {
    const investment = mockInvestments.find(inv => inv.id === investmentId);
    if (investment) {
      showToast(`Viewing investment: ${investment.userName} - ${investment.amount} BDT`);
    }
  };
  
  window.payWeeklyReturn = function(investmentId) {
    const investment = mockInvestments.find(inv => inv.id === investmentId);
    if (investment && investment.status === 'active') {
      investment.totalReturns += investment.weeklyReturn;
      investment.weeksRemaining = Math.max(0, investment.weeksRemaining - 1);
      
      if (investment.weeksRemaining === 0) {
        investment.status = 'completed';
      }
      
      // Save updated investments
      saveInvestments(mockInvestments);
      
      showToast(`Weekly return paid: ${investment.weeklyReturn} BDT to ${investment.userName}`);
      renderDashboard();
    }
  };
  
  window.closeInvestment = function(investmentId) {
    const investment = mockInvestments.find(inv => inv.id === investmentId);
    if (investment && investment.status === 'active') {
      investment.status = 'closed';
      investment.weeksRemaining = 0;
      
      // Save updated investments
      saveInvestments(mockInvestments);
      
      showToast(`Investment closed for ${investment.userName}`);
      renderDashboard();
    }
  };
  
  // Event listeners
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
      setAdminSession();
      showToast('Login successful!');
      showDashboard();
    } else {
      showToast('Invalid credentials!');
    }
  });
  
  logoutBtn.addEventListener('click', () => {
    clearAdminSession();
    showToast('Logged out successfully!');
    showLogin();
    loginForm.reset();
  });
  
  // Settings change handlers
  [toggleDeposits, toggleWithdrawals, toggleRegistrations, toggleRewards].forEach(toggle => {
    toggle.addEventListener('change', () => {
      const settings = {
        depositsEnabled: toggleDeposits.checked,
        withdrawalsEnabled: toggleWithdrawals.checked,
        registrationsEnabled: toggleRegistrations.checked,
        rewardsEnabled: toggleRewards.checked
      };
      saveAdminSettings(settings);
      showToast('Settings updated successfully!');
    });
  });
  
  // Video URL management
  window.updateVideoUrl = function(videoNumber) {
    const urlInput = document.getElementById(`video-${videoNumber}-url`);
    const url = urlInput.value.trim();
    
    if (!url) {
      showToast('Please enter a valid YouTube URL');
      return;
    }
    
    // Save to localStorage
    const videoUrls = JSON.parse(localStorage.getItem('videoAdUrls') || '{}');
    videoUrls[`video${videoNumber}`] = url;
    localStorage.setItem('videoAdUrls', JSON.stringify(videoUrls));
    
    showToast(`Video Ad #${videoNumber} URL updated successfully!`);
    urlInput.value = '';
  };

  // Initialize
  if (isAdminLoggedIn()) {
    // Reload all data when dashboard is shown
    users = loadUsers();
    const transactions = loadTransactions();
    pendingDeposits = transactions.deposits.filter(d => d.status === 'pending');
    pendingWithdrawals = transactions.withdrawals.filter(w => w.status === 'pending');
    mockInvestments = loadInvestments();
    
    // Load saved video URLs
    const videoUrls = JSON.parse(localStorage.getItem('videoAdUrls') || '{}');
    Object.entries(videoUrls).forEach(([key, url]) => {
      const number = key.replace('video', '');
      const input = document.getElementById(`video-${number}-url`);
      if (input) {
        input.value = url;
      }
    });
    
    showDashboard();
  } else {
    showLogin();
  }
})();
</script>
</body>
</html>
