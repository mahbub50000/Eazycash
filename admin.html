<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Telegram Mini App</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
  
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #fff;
    color: #333;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .admin-container {
    background: #fff9e6;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(255,215,0,0.3);
    overflow: hidden;
    width: 100%;
    max-width: 1200px;
    min-height: 600px;
  }
  
  .admin-header {
    background: #ffeb3b;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(255,235,59,0.8);
  }
  
  .admin-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1.2px;
    color: #333;
  }
  
  .admin-content {
    padding: 30px;
  }
  
  .login-section {
    max-width: 400px;
    margin: 0 auto;
    text-align: center;
  }
  
  .login-form {
    background: #fffde7;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(255,235,59,0.6);
  }
  
  .form-group {
    margin-bottom: 20px;
    text-align: left;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #666;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px 16px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ffeb3b;
    outline: none;
    background: #fff;
    color: #333;
    transition: background-color 0.3s, border-color 0.3s;
  }
  
  .form-group input:focus {
    background: #fffde7;
    border-color: #fbc02d;
  }
  
  .btn-login {
    width: 100%;
    padding: 14px;
    background: #ffeb3b;
    color: #333;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-login:hover {
    background: #fbc02d;
  }
  
  .btn-login:disabled {
    background: #fdd835;
    cursor: not-allowed;
  }
  
  .dashboard-section {
    display: none;
  }
  
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .dashboard-card {
    background: #fffde7;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(255,235,59,0.6);
  }
  
  .dashboard-card h3 {
    margin: 0 0 15px 0;
    color: #fbc02d;
    font-size: 1.2rem;
    border-bottom: 2px solid #ffeb3b;
    padding-bottom: 8px;
  }
  
  .stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,235,59,0.1);
  }
  
  .stat-value {
    font-weight: 600;
    color: #fbc02d;
  }
  
  .user-list {
    max-height: 300px;
    overflow-y: auto;
  }
  
  .user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,235,59,0.05);
    border-radius: 8px;
  }
  
  .user-info {
    flex-grow: 1;
  }
  
  .user-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
  }
  
  .user-details {
    font-size: 0.85rem;
    opacity: 0.8;
    color: #666;
  }
  
  .user-actions {
    display: flex;
    gap: 8px;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 0.8rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-approve {
    background: #8bc34a;
    color: #333;
  }
  
  .btn-reject {
    background: #f44336;
    color: white;
  }
  
  .btn-view {
    background: #ffeb3b;
    color: #333;
  }
  
  .btn-small:hover {
    opacity: 0.8;
  }
  
  .controls-section {
    background: #fff9e6;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .control-item {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .control-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .control-item label {
    font-weight: 600;
    cursor: pointer;
    color: #333;
  }
  
  .logout-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .logout-btn:hover {
    background: #d32f2f;
  }
  
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #fbc02d;
    color: #333;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(251,192,45,0.9);
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }
  
  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }
  
  .back-to-app {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background: #ffeb3b;
    color: #333;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  
  .back-to-app:hover {
    background: #fbc02d;
  }
</style>
</head>
<body>
<script src="api-client.js"></script>
<div class="admin-container">
  <div class="admin-header">
    <h1>Admin Panel</h1>
    <button id="logout-btn" class="logout-btn" style="display: none;">Logout</button>
  </div>
  
  <div class="admin-content">
    <!-- Login Section -->
    <div id="login-section" class="login-section">
      <div class="login-form">
        <h2>Admin Login</h2>
        <form id="admin-login-form">
          <div class="form-group">
            <label for="admin-username">Username:</label>
            <input type="text" id="admin-username" required>
          </div>
          <div class="form-group">
            <label for="admin-password">Password:</label>
            <input type="password" id="admin-password" required>
          </div>
          <button type="submit" class="btn-login">Login</button>
        </form>
        <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
          Demo credentials: admin / admin123
        </p>
        <a href="code.html" class="back-to-app">← Back to Main App</a>
      </div>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard-section">
      <!-- System Controls -->
      <div class="controls-section">
        <h3>System Controls</h3>
        <div class="controls-grid">
          <div class="control-item">
            <input type="checkbox" id="toggle-deposits" checked>
            <label for="toggle-deposits">Enable Deposits</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-withdrawals" checked>
            <label for="toggle-withdrawals">Enable Withdrawals</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-registrations" checked>
            <label for="toggle-registrations">Enable New Registrations</label>
          </div>
          <div class="control-item">
            <input type="checkbox" id="toggle-rewards" checked>
            <label for="toggle-rewards">Enable Reward Claims</label>
          </div>
        </div>
      </div>
      <!-- Notice Board Control -->
      <div class="controls-section" style="margin-top: 20px;">
        <h3>Notice Board</h3>
        <div class="form-group">
          <label for="notice-textarea">Notice Text:</label>
          <textarea id="notice-textarea" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ffeb3b; resize: vertical;"></textarea>
        </div>
        <button id="save-notice-btn" class="btn-login" style="background: #fbc02d; color: #333; margin-top: 10px;">Save Notice</button>
      </div>
      
      <!-- Dashboard Cards -->
      <div class="dashboard-grid">
        <!-- Statistics Card -->
        <div class="dashboard-card">
          <h3>System Statistics</h3>
          <div class="stat-item">
            <span>Total Users:</span>
            <span class="stat-value" id="total-users">0</span>
          </div>
          <div class="stat-item">
            <span>Active Users (24h):</span>
            <span class="stat-value" id="active-users">0</span>
          </div>
          <div class="stat-item">
            <span>Total Deposits:</span>
            <span class="stat-value" id="total-deposits">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Total Withdrawals:</span>
            <span class="stat-value" id="total-withdrawals">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Pending Requests:</span>
            <span class="stat-value" id="pending-requests">0</span>
          </div>
        </div>
        
        <!-- Recent Users -->
        <div class="dashboard-card">
          <h3>Recent Users</h3>
          <div class="user-list" id="recent-users">
            <!-- Users will be populated here -->
          </div>
        </div>
        
        <!-- Pending Deposits -->
        <div class="dashboard-card">
          <h3>Pending Deposits</h3>
          <div class="user-list" id="pending-deposits">
            <!-- Pending deposits will be populated here -->
          </div>
        </div>
        
        <!-- Pending Withdrawals -->
        <div class="dashboard-card">
          <h3>Pending Withdrawals</h3>
          <div class="user-list" id="pending-withdrawals">
            <!-- Pending withdrawals will be populated here -->
          </div>
        </div>
        
        <!-- Investment Tracking -->
        <div class="dashboard-card">
          <h3>Investment Tracking</h3>
          <div class="user-list" id="investment-tracking">
            <!-- Investment data will be populated here -->
          </div>
        </div>
        
        <!-- Investment Statistics -->
        <div class="dashboard-card">
          <h3>Investment Statistics</h3>
          <div class="stat-item">
            <span>Total Investments:</span>
            <span class="stat-value" id="total-investments">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Active Investors:</span>
            <span class="stat-value" id="active-investors">0</span>
          </div>
          <div class="stat-item">
            <span>Weekly Returns Paid:</span>
            <span class="stat-value" id="weekly-returns">0 BDT</span>
          </div>
          <div class="stat-item">
            <span>Average Investment:</span>
            <span class="stat-value" id="avg-investment">0 BDT</span>
          </div>
        </div>

        <!-- PPC Ads Management -->
          <div class="dashboard-card" style="grid-column: 1 / -1;">
          <h3>PPC Ads Management</h3>
          <form id="ppc-ads-form">
            <div id="ppc-ads-inputs" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <!-- PPC ad inputs will be dynamically inserted here -->
            </div>
            <button type="submit" class="btn-login" style="margin-top: 16px;">Save PPC Ads</button>
          </form>
          <div id="ppc-ads-status" style="margin-top: 10px; font-weight: 600; color: green;"></div>
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const ppcAdsInputsContainer = document.getElementById('ppc-ads-inputs');
            const ppcAdsForm = document.getElementById('ppc-ads-form');
            const ppcAdsStatus = document.getElementById('ppc-ads-status');

            // Create 10 input pairs for button link and ad script
            for (let i = 1; i <= 10; i++) {
              const linkGroup = document.createElement('div');
              linkGroup.className = 'form-group';
              const linkLabel = document.createElement('label');
              linkLabel.textContent = `Button Link #${i}:`;
              const linkInput = document.createElement('input');
              linkInput.type = 'text';
              linkInput.name = `buttonLink${i}`;
              linkInput.placeholder = 'Enter button link URL';
              linkInput.required = true;
              linkGroup.appendChild(linkLabel);
              linkGroup.appendChild(linkInput);

              const scriptGroup = document.createElement('div');
              scriptGroup.className = 'form-group';
              const scriptLabel = document.createElement('label');
              scriptLabel.textContent = `Ad Script #${i}:`;
              const scriptInput = document.createElement('textarea');
              scriptInput.name = `adScript${i}`;
              scriptInput.placeholder = 'Enter ad script HTML/JS';
              scriptInput.rows = 3;
              scriptInput.required = true;
              scriptGroup.appendChild(scriptLabel);
              scriptGroup.appendChild(scriptInput);

              ppcAdsInputsContainer.appendChild(linkGroup);
              ppcAdsInputsContainer.appendChild(scriptGroup);
            }

            // Load existing PPC ads data from backend API
            async function loadPpcAds() {
              try {
                const response = await fetch('/api/ppc-ads');
                if (!response.ok) throw new Error('Failed to load PPC ads');
                const data = await response.json();
                if (data.ppcAds && Array.isArray(data.ppcAds)) {
                  data.ppcAds.forEach(ad => {
                    const index = ad.ad_index;
                    const linkInput = ppcAdsForm.querySelector(`input[name="buttonLink${index}"]`);
                    const scriptInput = ppcAdsForm.querySelector(`textarea[name="adScript${index}"]`);
                    if (linkInput) linkInput.value = ad.buttonLink || '';
                    if (scriptInput) scriptInput.value = ad.ad_script || '';
                  });
                }
              } catch (error) {
                ppcAdsStatus.textContent = 'Error loading PPC ads: ' + error.message;
                ppcAdsStatus.style.color = 'red';
              }
            }

            // Save PPC ads data to backend API
            ppcAdsForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const ppcAds = [];
              for (let i = 1; i <= 10; i++) {
                const buttonLink = ppcAdsForm.querySelector(`input[name="buttonLink${i}"]`).value.trim();
                const adScript = ppcAdsForm.querySelector(`textarea[name="adScript${i}"]`).value.trim();
                ppcAds.push({ ad_index: i, buttonLink, ad_script: adScript });
              }
              try {
                const response = await fetch('/api/ppc-ads', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ppcAds })
                });
                if (!response.ok) throw new Error('Failed to save PPC ads');
                ppcAdsStatus.textContent = 'PPC ads saved successfully!';
                ppcAdsStatus.style.color = 'green';
              } catch (error) {
                ppcAdsStatus.textContent = 'Error saving PPC ads: ' + error.message;
                ppcAdsStatus.style.color = 'red';
              }
            });

            loadPpcAds();
          });
        </script>

        <!-- Support Chat Notifications -->
        <div class="dashboard-card" id="support-chat-section" style="margin-top: 20px;">
          <h3>Support Chat Notifications</h3>
          <div>
            <button id="refresh-support-count" class="btn-login" style="margin-bottom: 10px;">Refresh Unread Count</button>
            <span id="support-unread-count" style="font-weight: 600; color: #fbc02d;">Unread Messages: 0</span>
          </div>
          <div id="support-user-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #ffeb3b; border-radius: 8px; padding: 10px;">
            <!-- List of users with unread messages will be populated here -->
          </div>
          <div id="support-chat-window" style="display: none; margin-top: 20px; border: 1px solid #ffeb3b; border-radius: 8px; padding: 10px; max-height: 300px; overflow-y: auto;">
            <h4>Chat with User ID: <span id="chat-user-id"></span></h4>
            <div id="chat-messages" style="height: 200px; overflow-y: auto; background: #fffde7; padding: 10px; border-radius: 8px; margin-bottom: 10px;"></div>
            <textarea id="chat-input" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ffeb3b; resize: vertical;"></textarea>
            <button id="send-chat-message" class="btn-login" style="margin-top: 10px;">Send Reply</button>
            <button id="close-chat" class="btn-login" style="margin-top: 10px; background: #f44336; color: white;">Close Chat</button>
          </div>
        </div>
      </div>
      
      <a href="code.html" class="back-to-app">← Back to Main App</a>
    </div>
  </div>
</div>

<div id="toast" class="toast">Message</div>

<script>
(() => {
  // Admin credentials (in production, this should be server-side)
  const ADMIN_CREDENTIALS = {
    username: 'admin',
    password: 'admin123'
  };
  
  // Storage keys
  const ADMIN_SESSION_KEY = 'adminSession';
  const ADMIN_SETTINGS_KEY = 'adminSettings';
  
  // Elements
  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('admin-login-form');
  const logoutBtn = document.getElementById('logout-btn');
  const toastEl = document.getElementById('toast');
  
  // Control elements
  const toggleDeposits = document.getElementById('toggle-deposits');
  const toggleWithdrawals = document.getElementById('toggle-withdrawals');
  const toggleRegistrations = document.getElementById('toggle-registrations');
  const toggleRewards = document.getElementById('toggle-rewards');
  
  // Statistics elements
  const totalUsersEl = document.getElementById('total-users');
  const activeUsersEl = document.getElementById('active-users');
  const totalDepositsEl = document.getElementById('total-deposits');
  const totalWithdrawalsEl = document.getElementById('total-withdrawals');
  const pendingRequestsEl = document.getElementById('pending-requests');
  
  // List elements
  const recentUsersEl = document.getElementById('recent-users');
  const pendingDepositsEl = document.getElementById('pending-deposits');
  const pendingWithdrawalsEl = document.getElementById('pending-withdrawals');
  const investmentTrackingEl = document.getElementById('investment-tracking');
  
  // Investment statistics elements
  const totalInvestmentsEl = document.getElementById('total-investments');
  const activeInvestorsEl = document.getElementById('active-investors');
  const weeklyReturnsEl = document.getElementById('weekly-returns');
  const avgInvestmentEl = document.getElementById('avg-investment');
  
  // Admin session data
  let adminSession = null;
  let adminSettings = null;
  
  // Utility functions
  window.showToast = function(message, duration = 3000) {
    toastEl.textContent = message;
    toastEl.classList.add('show');
    setTimeout(() => {
      toastEl.classList.remove('show');
    }, duration);
  }
  
  function isAdminLoggedIn() {
    return adminSession !== null;
  }
  
  function setAdminSession(sessionData) {
    adminSession = sessionData;
    localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(sessionData));
  }
  
  function clearAdminSession() {
    adminSession = null;
    localStorage.removeItem(ADMIN_SESSION_KEY);
  }
  
  function loadAdminSession() {
    const sessionStr = localStorage.getItem(ADMIN_SESSION_KEY);
    if (sessionStr) {
      try {
        adminSession = JSON.parse(sessionStr);
      } catch {
        adminSession = null;
      }
    }
  }
  
  // API helper with auth
  async function apiFetch(url, options = {}) {
    options.headers = options.headers || {};
    if (adminSession && adminSession.token) {
      options.headers['Authorization'] = `Bearer ${adminSession.token}`;
    }
    const response = await fetch(url, options);
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'API request failed');
    }
    return response.json();
  }
  
  // Load admin settings from backend or localStorage fallback
  async function loadAdminSettings() {
    if (!isAdminLoggedIn()) return getDefaultSettings();
    try {
      // TODO: Implement backend API for admin settings if available
      const settingsStr = localStorage.getItem(ADMIN_SETTINGS_KEY);
      if (settingsStr) {
        return JSON.parse(settingsStr);
      }
      return getDefaultSettings();
    } catch {
      return getDefaultSettings();
    }
  }
  
  // Save admin settings to localStorage and backend if applicable
  async function saveAdminSettings(settings) {
    localStorage.setItem(ADMIN_SETTINGS_KEY, JSON.stringify(settings));
    // TODO: Implement backend API call to save settings if available
  }
  
  function getDefaultSettings() {
    return {
      depositsEnabled: true,
      withdrawalsEnabled: true,
      registrationsEnabled: true,
      rewardsEnabled: true
    };
  }
  
  // Fetch users from backend
  async function fetchUsers() {
    try {
      const response = await apiFetch('/api/users');
      return response.users || [];
    } catch (error) {
      showToast('Error fetching users: ' + error.message);
      return [];
    }
  }
  
  // Fetch statistics from backend
  async function fetchStatistics() {
    try {
      const response = await apiFetch('/api/statistics');
      return response;
    } catch (error) {
      showToast('Error fetching statistics: ' + error.message);
      return {
        totalUsers: 0,
        activeUsers: 0,
        totalDeposits: 0,
        totalWithdrawals: 0,
        pendingRequests: 0
      };
    }
  }
  
  // Fetch pending deposits from backend
  async function fetchPendingDeposits() {
    try {
      const response = await apiFetch('/api/deposits?status=pending');
      return response.deposits || [];
    } catch (error) {
      showToast('Error fetching pending deposits: ' + error.message);
      return [];
    }
  }
  
  // Fetch pending withdrawals from backend
  async function fetchPendingWithdrawals() {
    try {
      const response = await apiFetch('/api/withdrawals?status=pending');
      return response.withdrawals || [];
    } catch (error) {
      showToast('Error fetching pending withdrawals: ' + error.message);
      return [];
    }
  }
  
  // Fetch investments from backend
  async function fetchInvestments() {
    try {
      const response = await apiFetch('/api/investments');
      return response.investments || [];
    } catch (error) {
      showToast('Error fetching investments: ' + error.message);
      return [];
    }
  }
  
  // Approve deposit
  async function approveDeposit(depositId) {
    try {
      await apiFetch(`/api/deposits/${depositId}/approve`, { method: 'POST' });
      showToast('Deposit approved');
      await loadAndRenderDashboard();
    } catch (error) {
      showToast('Error approving deposit: ' + error.message);
    }
  }
  
  // Reject deposit
  async function rejectDeposit(depositId) {
    try {
      await apiFetch(`/api/deposits/${depositId}/reject`, { method: 'POST' });
      showToast('Deposit rejected');
      await loadAndRenderDashboard();
    } catch (error) {
      showToast('Error rejecting deposit: ' + error.message);
    }
  }
  
  // Approve withdrawal
  async function approveWithdrawal(withdrawalId) {
    try {
      await apiFetch(`/api/withdrawals/${withdrawalId}/approve`, { method: 'POST' });
      showToast('Withdrawal approved');
      await loadAndRenderDashboard();
    } catch (error) {
      showToast('Error approving withdrawal: ' + error.message);
    }
  }
  
  // Reject withdrawal
  async function rejectWithdrawal(withdrawalId) {
    try {
      await apiFetch(`/api/withdrawals/${withdrawalId}/reject`, { method: 'POST' });
      showToast('Withdrawal rejected');
      await loadAndRenderDashboard();
    } catch (error) {
      showToast('Error rejecting withdrawal: ' + error.message);
    }
  }
  
  // Render dashboard with fetched data
  async function renderDashboard(data) {
    const { users, statistics, pendingDeposits, pendingWithdrawals, investments } = data;
    
    totalUsersEl.textContent = statistics.totalUsers;
    activeUsersEl.textContent = statistics.activeUsers;
    totalDepositsEl.textContent = statistics.totalDeposits.toFixed(2) + ' BDT';
    totalWithdrawalsEl.textContent = statistics.totalWithdrawals.toFixed(2) + ' BDT';
    pendingRequestsEl.textContent = statistics.pendingRequests;
    
    recentUsersEl.innerHTML = users.slice(0, 5).map(user => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${user.first_name} ${user.last_name || ''}</div>
          <div class="user-details">ID: ${user.id}</div>
          <div class="user-details">Username: ${user.username || 'N/A'}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-view" onclick="viewUser(${user.id})">View</button>
        </div>
      </div>
    `).join('');
    
    pendingDepositsEl.innerHTML = pendingDeposits.map(deposit => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${deposit.userName}</div>
          <div class="user-details">${deposit.amount} BDT via ${deposit.method}</div>
          <div class="user-details">Ref: ${deposit.reference}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-approve" onclick="approveDeposit(${deposit.id})">Approve</button>
          <button class="btn-small btn-reject" onclick="rejectDeposit(${deposit.id})">Reject</button>
        </div>
      </div>
    `).join('');
    
    pendingWithdrawalsEl.innerHTML = pendingWithdrawals.map(withdrawal => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${withdrawal.userName}</div>
          <div class="user-details">${withdrawal.amount} BDT via ${withdrawal.method}</div>
          <div class="user-details">To: ${withdrawal.address}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-approve" onclick="approveWithdrawal(${withdrawal.id})">Approve</button>
          <button class="btn-small btn-reject" onclick="rejectWithdrawal(${withdrawal.id})">Reject</button>
        </div>
      </div>
    `).join('');
    
    investmentTrackingEl.innerHTML = investments.map(investment => `
      <div class="user-item">
        <div class="user-info">
          <div class="user-name">${investment.userName}</div>
          <div class="user-details">Investment: ${investment.amount} BDT | Status: ${investment.status}</div>
          <div class="user-details">Started: ${new Date(investment.startDate).toLocaleDateString()}</div>
        </div>
        <div class="user-actions">
          <button class="btn-small btn-view" onclick="viewInvestment(${investment.id})">View</button>
        </div>
      </div>
    `).join('');
    
    // Update investment statistics
    const totalInvestmentAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
    const activeInvestments = investments.filter(inv => inv.status === 'active');
    const totalWeeklyReturns = investments.reduce((sum, inv) => sum + (inv.weeklyReturn || 0), 0);
    const avgInvestment = investments.length > 0 ? totalInvestmentAmount / investments.length : 0;
    
    totalInvestmentsEl.textContent = totalInvestmentAmount.toFixed(2) + ' BDT';
    activeInvestorsEl.textContent = activeInvestments.length;
    weeklyReturnsEl.textContent = totalWeeklyReturns.toFixed(2) + ' BDT';
    avgInvestmentEl.textContent = avgInvestment.toFixed(2) + ' BDT';
  }
  
  async function loadAndRenderDashboard() {
    try {
      const [users, statistics, pendingDeposits, pendingWithdrawals, investments] = await Promise.all([
        fetchUsers(),
        fetchStatistics(),
        fetchPendingDeposits(),
        fetchPendingWithdrawals(),
        fetchInvestments()
      ]);
      await renderDashboard({ users, statistics, pendingDeposits, pendingWithdrawals, investments });
    } catch (error) {
      showToast('Error loading dashboard: ' + error.message);
    }
  }
  
  function showDashboard() {
    loginSection.style.display = 'none';
    dashboardSection.style.display = 'block';
    logoutBtn.style.display = 'block';
    
    loadAdminSettings().then(settings => {
      adminSettings = settings;
      toggleDeposits.checked = settings.depositsEnabled;
      toggleWithdrawals.checked = settings.withdrawalsEnabled;
      toggleRegistrations.checked = settings.registrationsEnabled;
      toggleRewards.checked = settings.rewardsEnabled;
    });
    
    loadAndRenderDashboard();
  }
  
  function showLogin() {
    loginSection.style.display = 'block';
    dashboardSection.style.display = 'none';
    logoutBtn.style.display = 'none';
  }
  
  // Event listeners
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
      setAdminSession({ username, token: 'dummy-token' });
      showToast('Login successful!');
      showDashboard();
    } else {
      showToast('Invalid credentials!');
    }
  });
  
  logoutBtn.addEventListener('click', () => {
    clearAdminSession();
    showToast('Logged out successfully!');
    showLogin();
    loginForm.reset();
  });
  
  // Settings change handlers
  [toggleDeposits, toggleWithdrawals, toggleRegistrations, toggleRewards].forEach(toggle => {
    toggle.addEventListener('change', () => {
      const settings = {
        depositsEnabled: toggleDeposits.checked,
        withdrawalsEnabled: toggleWithdrawals.checked,
        registrationsEnabled: toggleRegistrations.checked,
        rewardsEnabled: toggleRewards.checked
      };
      saveAdminSettings(settings);
      showToast('Settings updated successfully!');
    });
  });
  
  // Global functions for button actions
  window.approveDeposit = approveDeposit;
  window.rejectDeposit = rejectDeposit;
  window.approveWithdrawal = approveWithdrawal;
  window.rejectWithdrawal = rejectWithdrawal;
  
  window.viewUser = function(userId) {
    showToast(`Viewing user ID: ${userId}`);
  };
  
  window.viewInvestment = function(investmentId) {
    showToast(`Viewing investment ID: ${investmentId}`);
  };
  
  // Initialize
  loadAdminSession();
  if (isAdminLoggedIn()) {
    showDashboard();
  } else {
    showLogin();
  }
})();
  </script>
  <script>
    (() => {
      const noticeTextarea = document.getElementById('notice-textarea');
      const saveNoticeBtn = document.getElementById('save-notice-btn');
      const toastEl = document.getElementById('toast');

      function showToast(message, duration = 3000) {
        toastEl.textContent = message;
        toastEl.classList.add('show');
        setTimeout(() => {
          toastEl.classList.remove('show');
        }, duration);
      }

      // Load saved notice text from localStorage on page load
      function loadNoticeText() {
        const savedNotice = localStorage.getItem('noticeText') || '';
        if (noticeTextarea) {
          noticeTextarea.value = savedNotice;
        }
      }

      // Save notice text to localStorage when save button clicked
      if (saveNoticeBtn) {
        saveNoticeBtn.addEventListener('click', () => {
          if (noticeTextarea) {
            const text = noticeTextarea.value.trim();
            localStorage.setItem('noticeText', text);
            showToast('Notice text saved successfully!');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', loadNoticeText);
    })();
  </script>

  <script>
    (() => {
      // Support chat variables
      let supportUnreadCount = 0;
      let supportUsersWithUnread = [];
      let currentChatUserId = null;
      const supportUnreadCountEl = document.createElement('span');
      const supportUserListEl = document.createElement('div');
      const supportChatWindowEl = document.createElement('div');
      const chatUserIdEl = document.createElement('span');
      const chatMessagesEl = document.createElement('div');
      const chatInputEl = document.createElement('textarea');
      const sendChatMessageBtn = document.createElement('button');
      const closeChatBtn = document.createElement('button');

      // Elements from DOM
      const supportUnreadCountSpan = document.getElementById('support-unread-count');
      const supportUserListDiv = document.getElementById('support-user-list');
      const supportChatWindowDiv = document.getElementById('support-chat-window');
      const chatUserIdSpan = document.getElementById('chat-user-id');
      const chatMessagesDiv = document.getElementById('chat-messages');
      const chatInputTextarea = document.getElementById('chat-input');
      const sendChatMessageButton = document.getElementById('send-chat-message');
      const closeChatButton = document.getElementById('close-chat');
      const refreshSupportCountBtn = document.getElementById('refresh-support-count');

      // Fetch unread count and update UI
      async function fetchUnreadCount() {
        try {
          const data = await window.api.getSupportUnreadCount();
          supportUnreadCount = data.unread_count || 0;
          supportUnreadCountSpan.textContent = `Unread Messages: ${supportUnreadCount}`;
          if (supportUnreadCount > 0) {
            await fetchUsersWithUnreadMessages();
          } else {
            supportUserListDiv.innerHTML = '<p>No unread messages</p>';
          }
        } catch (error) {
          showToast('Error fetching unread count: ' + error.message);
        }
      }

      // Fetch users who have unread messages
      async function fetchUsersWithUnreadMessages() {
        try {
          // For simplicity, fetch all users and filter those with unread messages
          const users = await window.api.getUserList ? await window.api.getUserList() : [];
          // We don't have an API to get users with unread messages, so we will fetch all messages and filter
          // Instead, we can fetch all support messages and extract unique user_ids with unread messages
          // For now, just show all users (or empty)
          supportUsersWithUnread = users; // Placeholder
          renderSupportUserList();
        } catch (error) {
          showToast('Error fetching users with unread messages: ' + error.message);
        }
      }

      // Render the list of users with unread messages
      function renderSupportUserList() {
        if (supportUsersWithUnread.length === 0) {
          supportUserListDiv.innerHTML = '<p>No users with unread messages</p>';
          return;
        }
        supportUserListDiv.innerHTML = supportUsersWithUnread.map(user => `
          <div class="user-item" style="cursor:pointer;" data-user-id="${user.id}">
            <div class="user-info">
              <div class="user-name">${user.first_name} ${user.last_name || ''}</div>
              <div class="user-details">ID: ${user.id}</div>
              <div class="user-details">Username: ${user.username || 'N/A'}</div>
            </div>
          </div>
        `).join('');
        // Add click listeners
        supportUsersWithUnread.forEach(user => {
          const el = supportUserListDiv.querySelector(`[data-user-id="${user.id}"]`);
          if (el) {
            el.addEventListener('click', () => openChat(user.id));
          }
        });
      }

      // Open chat window for a user
      async function openChat(userId) {
        currentChatUserId = userId;
        chatUserIdSpan.textContent = userId;
        supportChatWindowDiv.style.display = 'block';
        await loadChatMessages(userId);
        await window.api.markSupportMessagesRead(userId);
        await fetchUnreadCount();
      }

      // Load chat messages for a user
      async function loadChatMessages(userId) {
        try {
          const data = await window.api.getSupportMessages(userId);
          const messages = data.messages || [];
          chatMessagesDiv.innerHTML = messages.map(msg => `
            <div style="margin-bottom: 8px; text-align: ${msg.sender === 'admin' ? 'right' : 'left'};">
              <div style="display: inline-block; background: ${msg.sender === 'admin' ? '#fbc02d' : '#fffde7'}; padding: 8px 12px; border-radius: 12px; max-width: 70%;">
                <small style="font-weight: 600;">${msg.sender === 'admin' ? 'Admin' : 'User'}</small><br/>
                ${msg.message}
                <br/><small style="font-size: 0.7rem; opacity: 0.7;">${new Date(msg.created_at).toLocaleString()}</small>
              </div>
            </div>
          `).join('');
          chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        } catch (error) {
          showToast('Error loading chat messages: ' + error.message);
        }
      }

      // Send admin reply
      async function sendReply() {
        const message = chatInputTextarea.value.trim();
        if (!message) {
          showToast('Please enter a message');
          return;
        }
        try {
          await window.api.sendAdminReply(currentChatUserId, message);
          chatInputTextarea.value = '';
          await loadChatMessages(currentChatUserId);
        } catch (error) {
          showToast('Error sending reply: ' + error.message);
        }
      }

      // Close chat window
      function closeChat() {
        currentChatUserId = null;
        supportChatWindowDiv.style.display = 'none';
        chatMessagesDiv.innerHTML = '';
        chatInputTextarea.value = '';
      }

      // Event listeners
      sendChatMessageButton.addEventListener('click', sendReply);
      closeChatButton.addEventListener('click', closeChat);
      refreshSupportCountBtn.addEventListener('click', fetchUnreadCount);

      // Polling for unread count every 30 seconds
      setInterval(fetchUnreadCount, 30000);

      // Initial fetch
      fetchUnreadCount();
    })();
  </script>
</body>
</html>
